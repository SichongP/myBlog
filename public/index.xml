<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Academic on Academic</title>
    <link>/</link>
    <description>Recent content in Academic on Academic</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Thu, 09 Jan 2020 00:00:00 +0000</lastBuildDate>
    <atom:link href="/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>/dev/stderr vs &gt;&amp;2: a dive into Linux STDIO</title>
      <link>/post/dev-stdout-vs-2-a-dive-into-linux-stdio/</link>
      <pubDate>Thu, 09 Jan 2020 00:00:00 +0000</pubDate>
      
      <guid>/post/dev-stdout-vs-2-a-dive-into-linux-stdio/</guid>
      <description>

&lt;p&gt;I was assisting a bioinformatics workshop for FAANG group at Plant and Animal Genome (PAG) and I ran into an interesting question with an example provided by one of the instructors on the topic of Linux output redirecting. Take a look at this simplified example script &lt;code&gt;print_stderr.sh&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash

echo &amp;quot;first line of stderr&amp;quot; &amp;gt; /dev/stderr
echo &amp;quot;second line of stderr&amp;quot; &amp;gt; /dev/stderr
echo &amp;quot;third line of stderr&amp;quot; &amp;gt; /dev/stderr

echo &amp;quot;A line of stdout&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if we redirect the stderr of this script to a file, instead of all three lines of stderr messages, we only see the last line!&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ./print_stderr.sh 2&amp;gt; err.log
$ cat err.log
third line of stderr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Why is this happening??&lt;/p&gt;

&lt;p&gt;Now remember, when we redirect output of a command to stderr, we typically do it like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;command &amp;gt;&amp;amp;2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What if we modify the script according to this?&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash

echo &amp;quot;first line of stderr&amp;quot; &amp;gt;&amp;amp;2
echo &amp;quot;second line of stderr&amp;quot; &amp;gt;&amp;amp;2
echo &amp;quot;third line of stderr&amp;quot; &amp;gt;&amp;amp;2

echo &amp;quot;A line of stdout&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./print_stderr.sh 2&amp;gt; err.log
$ cat err.log
first line of stderr
second line of stderr
third line of stderr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now it works as we intended it to! So what&amp;rsquo;s the difference?&lt;/p&gt;

&lt;p&gt;Notice that I quoted &amp;ldquo;redirect&amp;rdquo; above. Because what &amp;ldquo;&amp;gt;&amp;amp;&amp;rdquo; idiom really does is duplicating, not redirecting. And that is the key to understand this interesting behaviour here.&lt;/p&gt;

&lt;p&gt;To understand the difference, we first need to go over the three special file descriptors and how Linux handles its STDIO.&lt;/p&gt;

&lt;h2 id=&#34;what-is-a-file-descriptor&#34;&gt;What is a file descriptor&lt;/h2&gt;

&lt;p&gt;When a process starts, the kernel indexes all the files it requires and associate them with what are known as &amp;ldquo;file descriptors&amp;rdquo;. In Linux systems, the first three files descriptors (&lt;code&gt;0&lt;/code&gt;, &lt;code&gt;1&lt;/code&gt;, and &lt;code&gt;2&lt;/code&gt;) are by default &lt;code&gt;STDIN&lt;/code&gt;, &lt;code&gt;STDOUT&lt;/code&gt;, and &lt;code&gt;STDERR&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;You may have heard that on a linux system, &amp;ldquo;everything is a file&amp;rdquo;. And that is also true with I/O. &lt;code&gt;STDIN&lt;/code&gt;, &lt;code&gt;STDOUT&lt;/code&gt;, and &lt;code&gt;STDERR&lt;/code&gt; all point to files on a system. When a process runs, it reads data from &lt;code&gt;STDIN&lt;/code&gt; and writes to &lt;code&gt;STDOUT&lt;/code&gt; and &lt;code&gt;STDERR&lt;/code&gt;. Whether that &lt;code&gt;STDOUT&lt;/code&gt; then goes to a console, a file, or something else is handled by the kernel. This level of absraction makes Linux particularly powerful and portable.&lt;/p&gt;

&lt;h2 id=&#34;how-does-redirecting-work&#34;&gt;How does redirecting work?&lt;/h2&gt;

&lt;p&gt;So when we write a command like this in a bash shell:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;command 2&amp;gt; err.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We are essentially telling the shell to write &lt;code&gt;STDERR&lt;/code&gt; to a file &lt;code&gt;err.log&lt;/code&gt; instead of its default place.&lt;/p&gt;

&lt;p&gt;Now where would that default place be?&lt;/p&gt;

&lt;p&gt;In an interactive shell, all three STDIO streams by default point to a device file. Many shells, including Bash, implement symlink files &lt;code&gt;/dev/stdin&lt;/code&gt;, &lt;code&gt;/dev/stdout&lt;/code&gt;, and &lt;code&gt;/dev/stderr&lt;/code&gt;. These links point to &lt;code&gt;/proc/$pid/fd/0&lt;/code&gt;, &lt;code&gt;/proc/$pid/fd/1&lt;/code&gt;, &lt;code&gt;/proc/$pid/fd/2&lt;/code&gt;, respectively.&lt;/p&gt;

&lt;p&gt;If you take a look at these files, you can see that they all point to a device file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lah /proc/self/fd/[0,1,2]
lrwx------ 1 sichong sichong 64 Jan  9 12:40 /proc/self/fd/0 -&amp;gt; /dev/pts/2
lrwx------ 1 sichong sichong 64 Jan  9 12:40 /proc/self/fd/1 -&amp;gt; /dev/pts/2
lrwx------ 1 sichong sichong 64 Jan  9 12:40 /proc/self/fd/2 -&amp;gt; /dev/pts/2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not to go into too much detail, &lt;code&gt;/dev/pts/2&lt;/code&gt; is a pseudo-terminal created by your current interactive shell. It allows the shell to read your keyboard input, as well as to write to your screen. Try writing something to this device file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ echo &amp;quot;Hello&amp;quot; &amp;gt; /dev/pts/2
Hello
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It immediately shows up on your screen!&lt;/p&gt;

&lt;p&gt;Now you would ask, shouldn&amp;rsquo;t every process have its own STDIO streams? If they all end up to the same place, how does the kernel know where each stream go to?&lt;/p&gt;

&lt;p&gt;Precisely! Every process gets its own set of file descriptors (stroed in &lt;code&gt;/proc/$pid/fd&lt;/code&gt; where &lt;code&gt;$pid&lt;/code&gt; is the process id). Now you probably know that when we run a script in an interactive shell, the shell calls a child process to run the script. So where do the STDIO streams of the child process point to?&lt;/p&gt;

&lt;p&gt;It turns out that by default, the child process inherits from the parent process its STDIO targets. We can verify this by running a script like this(&lt;code&gt;show_file_descriptors.sh&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash
filan -s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(You may need to install this program with &lt;code&gt;sudo apt install socat&lt;/code&gt;)&lt;/p&gt;

&lt;p&gt;And you should see an output that looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ./show_file_descriptors.sh
    0 tty /dev/pts/2
    1 tty /dev/pts/2
    2 tty /dev/pts/2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This tells us that our file descriptors all point to &lt;code&gt;/dev/pts/2&lt;/code&gt; (same device file as our current shell session!) which is connected to a tty device.&lt;/p&gt;

&lt;p&gt;Now what happens if I redirect the &lt;code&gt;STDERR&lt;/code&gt; of this file to a different file?&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ./show_file_descriptors.sh 2&amp;gt; err.log
    0 tty /dev/pts/2
    1 tty /dev/pts/2
    2 file /home/sichong/err.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now it&amp;rsquo;s different! Our file descriptor &lt;code&gt;2&lt;/code&gt; now points to the file &lt;code&gt;err.log&lt;/code&gt;!&lt;/p&gt;

&lt;p&gt;To summarize, an interactive shell by default have all three of its STDIO streams (&lt;code&gt;STDIN&lt;/code&gt;, &lt;code&gt;STDOUT&lt;/code&gt;, &lt;code&gt;STDERR&lt;/code&gt;) point to a same device file in &lt;code&gt;/dev/pts&lt;/code&gt; directory. All child processes spawned by this shell session by dafault inherit the same file descriptors. (Hence when we run a program in a shell session it can take input from keyboard and we see its output on a screen, unless handled differently by the program.) But when we redirect input or output of a program, the spawned child process gets new file descriptors that point to redirected files.&lt;/p&gt;

&lt;h2 id=&#34;so-what-happened&#34;&gt;So, what happened?&lt;/h2&gt;

&lt;p&gt;At this point, it is probably clear to you already why the script we used at the workshop didn&amp;rsquo;t work as intended:
The child process running the script gets &lt;code&gt;err.log&lt;/code&gt; as its &lt;code&gt;STDERR&lt;/code&gt;. This means that the &lt;code&gt;/dev/stderr&lt;/code&gt; link points to &lt;code&gt;/proc/self/fd/2&lt;/code&gt; which points to &lt;code&gt;err.log&lt;/code&gt; instead of &lt;code&gt;/dev/pts/2&lt;/code&gt;! So now when you redirect command of &lt;code&gt;echo&lt;/code&gt; to &lt;code&gt;/dev/stderr&lt;/code&gt; in the script, you&amp;rsquo;re actually redirecting it to a file &lt;code&gt;err.log&lt;/code&gt;. And since we are using &lt;code&gt;&amp;gt;&lt;/code&gt; instead of &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; to truncate the file, we only get whatever gets put in last.&lt;/p&gt;

&lt;p&gt;To test our hypothesis, we can modify our script to use &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; instead of &lt;code&gt;&amp;gt;&lt;/code&gt; after each &lt;code&gt;echo&lt;/code&gt; command. If our theory stands, this should make our script behave!&lt;/p&gt;

&lt;p&gt;&lt;code&gt;print_stderr.sh&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash

echo &amp;quot;first line of stderr&amp;quot; &amp;gt;&amp;gt; /dev/stderr
echo &amp;quot;second line of stderr&amp;quot; &amp;gt;&amp;gt; /dev/stderr
echo &amp;quot;third line of stderr&amp;quot; &amp;gt;&amp;gt; /dev/stderr

echo &amp;quot;A line of stdout&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now let&amp;rsquo;s try it again:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./print_stderr.sh 2&amp;gt; err.log
$ cat err.log
first line of stderr
second line of stderr
third line of stderr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Tada!&lt;/p&gt;

&lt;h2 id=&#34;but-why-is-different-then&#34;&gt;But why is &lt;code&gt;&amp;gt;&amp;amp;&lt;/code&gt; different then?&lt;/h2&gt;

&lt;p&gt;To understand this, we need to dive deeper into how Linux systems handle redirecting. We are gonna use a program called &lt;code&gt;strace&lt;/code&gt; to follow the system and see how it handles file descriptor at each step.
Try a simple command:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;ls &amp;gt; out&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We would get output like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;out&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
dup2(3, 1)                              = 1
strace: Process 10444 attached
[pid 10444] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libselinux.so.1&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/libpcre2-8.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libpthread.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/proc/filesystems&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10444] openat(AT_FDCWD, &amp;quot;.&amp;quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3
[pid 10444] write(1, &amp;quot;anaconda3\nandroid-studio\nApps\nbi&amp;quot;..., 268) = 268
[pid 10444] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=10444, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 1)                             = 1
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Some important lines to notice:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;out&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This line indicates that the kernel opens file &lt;code&gt;out&lt;/code&gt; and assignes it a file descriptor &lt;code&gt;3&lt;/code&gt;.
Notice the &lt;code&gt;O_TRUNC&lt;/code&gt; keyword here. This is where truncating happens with &lt;code&gt;&amp;gt;&lt;/code&gt; redirecting: the system tries to open the target file, and truncate it if not empty, before the command is even evaluated!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;On a side note, this is also why doing &lt;code&gt;sort data.txt &amp;gt; data.txt&lt;/code&gt; could potentially get you fired :)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;After this step, the file is ready for writing and will take wahtever comes to it in sequential order, meaning no more truncating or overwriting will happen! (Unless another redirecting to the same file happens.)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dup2(3, 1)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This line suggests that the kernel duplicates the value of file descriptor &lt;code&gt;3&lt;/code&gt; (which points to &lt;code&gt;out&lt;/code&gt;) to file descriptor &lt;code&gt;1&lt;/code&gt; (&lt;code&gt;STDOUT&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;Now at this point the &lt;code&gt;STDOUT&lt;/code&gt; points to &lt;code&gt;out&lt;/code&gt; instead of &lt;code&gt;/dev/pts/2&lt;/code&gt;!&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;strace: Process 10444 attached
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This process means that a child process is called to run &lt;code&gt;ls&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;write(1, &amp;quot;anaconda3\nandroid-studio\nApps\nbi&amp;quot;..., 268) = 268
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This line means that the output of &lt;code&gt;ls&lt;/code&gt; is being written to file descriptor &lt;code&gt;1&lt;/code&gt;, which points to &lt;code&gt;out&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So this is what happens under the hood when we tell our shell to redirect the output of &lt;code&gt;ls&lt;/code&gt; to a file named &lt;code&gt;out&lt;/code&gt;!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;What if instead of &lt;code&gt;&amp;gt;&lt;/code&gt; we use &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; to redirect output of &lt;code&gt;ls&lt;/code&gt;?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now let&amp;rsquo;s make a script (&lt;code&gt;redirect.sh&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash
echo &amp;quot;Hello,&amp;quot;
echo &amp;quot;World!&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And let&amp;rsquo;s trace what happens when we redirect output of this script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;./redirect.sh &amp;gt; out&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You should see output similar to this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;out&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
dup2(3, 1)                              = 1
strace: Process 10970 attached
[pid 10970] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libtinfo.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/dev/tty&amp;quot;, O_RDWR|O_NONBLOCK) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&amp;quot;, O_RDONLY) = 3
[pid 10970] openat(AT_FDCWD, &amp;quot;./test&amp;quot;, O_RDONLY) = 3
[pid 10970] dup2(3, 255)                = 255
[pid 10970] write(1, &amp;quot;Hello,\n&amp;quot;, 7)     = 7
[pid 10970] write(1, &amp;quot;World!\n&amp;quot;, 7)     = 7
[pid 10970] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=10970, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 1)                             = 1
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is very similar to what we see before. Notice that the child process does not attempt to open &lt;code&gt;out&lt;/code&gt; file again! That is why &lt;code&gt;./redirect.sh &amp;gt; out&lt;/code&gt; will print&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Hello,
World!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;to file &lt;code&gt;out&lt;/code&gt; instead of only the last line!&lt;/p&gt;

&lt;p&gt;But now let&amp;rsquo;s modify our script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash
echo &amp;quot;Hello,&amp;quot; &amp;gt; /dev/stderr
echo &amp;quot;World!&amp;quot; &amp;gt; /dev/stderr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And redirect output of this script to a file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;./redirect.sh 2&amp;gt; err&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you will see output like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;err&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
dup2(3, 2)                              = 2
strace: Process 11106 attached
[pid 11106] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libtinfo.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/dev/tty&amp;quot;, O_RDWR|O_NONBLOCK) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&amp;quot;, O_RDONLY) = 3
[pid 11106] openat(AT_FDCWD, &amp;quot;./test&amp;quot;, O_RDONLY) = 3
[pid 11106] dup2(3, 255)                = 255
[pid 11106] openat(AT_FDCWD, &amp;quot;/dev/stderr&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
[pid 11106] dup2(3, 1)                  = 1
[pid 11106] write(1, &amp;quot;Hello,\n&amp;quot;, 7)     = 7
[pid 11106] dup2(10, 1)                 = 1
[pid 11106] openat(AT_FDCWD, &amp;quot;/dev/stderr&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
[pid 11106] dup2(3, 1)                  = 1
[pid 11106] write(1, &amp;quot;World!\n&amp;quot;, 7)     = 7
[pid 11106] dup2(10, 1)                 = 1
[pid 11106] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=11106, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 2)                             = 2
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that the same file &lt;code&gt;err&lt;/code&gt; is opened and truncated three times here:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;err&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;First it is opened by parent process and assigned file desccriptor &lt;code&gt;3&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dup2(3, 2) 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then in the parent process the value of file descriptor &lt;code&gt;3&lt;/code&gt; is copied to &lt;code&gt;2&lt;/code&gt; (&lt;code&gt;STDERR&lt;/code&gt;). And then child process is called which inherits the parent&amp;rsquo;s &lt;code&gt;STDERR&lt;/code&gt; (points to &lt;code&gt;err&lt;/code&gt; at this point).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[pid 11106] openat(AT_FDCWD, &amp;quot;/dev/stderr&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
[pid 11106] dup2(3, 1)                  = 1
[pid 11106] write(1, &amp;quot;Hello,\n&amp;quot;, 7)     = 7
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then the child process attempts to open the file it&amp;rsquo;s supposed to redirect to (&lt;code&gt;/dev/stderr&lt;/code&gt;), truncates it, and assigns it a file descriptor &lt;code&gt;3&lt;/code&gt; (separately stored from parent&amp;rsquo;s descriptors). Then it copies the value of file descriptor &lt;code&gt;3&lt;/code&gt; to &lt;code&gt;1&lt;/code&gt; (&lt;code&gt;STDOUT&lt;/code&gt;). This completes the redirecting following &lt;code&gt;echo&lt;/code&gt; command (&lt;code&gt;&amp;gt; /dev/stderr&lt;/code&gt;). And finally it writes output of &lt;code&gt;echo&lt;/code&gt; command to its &lt;code&gt;STDOUT&lt;/code&gt; (which now points to &lt;code&gt;err&lt;/code&gt; file).&lt;/p&gt;

&lt;p&gt;And the same process repeats with the second &lt;code&gt;echo&lt;/code&gt; command, removing output in the &lt;code&gt;err&lt;/code&gt; file by the first &lt;code&gt;echo&lt;/code&gt; command.&lt;/p&gt;

&lt;p&gt;This all makes sense, but why is &lt;code&gt;&amp;gt;&amp;amp;&lt;/code&gt; different?&lt;/p&gt;

&lt;p&gt;Well let&amp;rsquo;s see what our system does when we use &lt;code&gt;&amp;gt;&amp;amp;&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;But now let&amp;rsquo;s modify our script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/usr/bin/bash
echo &amp;quot;Hello,&amp;quot; &amp;gt;&amp;amp; 2
echo &amp;quot;World!&amp;quot; &amp;gt;&amp;amp; 2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And run it again like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;./redirect.sh 2&amp;gt; err&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now check out the output:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;err&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
dup2(3, 2)                              = 2
strace: Process 11593 attached
[pid 11593] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libtinfo.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/dev/tty&amp;quot;, O_RDWR|O_NONBLOCK) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&amp;quot;, O_RDONLY) = 3
[pid 11593] openat(AT_FDCWD, &amp;quot;./test&amp;quot;, O_RDONLY) = 3
[pid 11593] dup2(3, 255)                = 255
[pid 11593] dup2(2, 1)                  = 1
[pid 11593] write(1, &amp;quot;Hello,\n&amp;quot;, 7)     = 7
[pid 11593] dup2(10, 1)                 = 1
[pid 11593] dup2(2, 1)                  = 1
[pid 11593] write(1, &amp;quot;World!\n&amp;quot;, 7)     = 7
[pid 11593] dup2(10, 1)                 = 1
[pid 11593] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=11593, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 2)                             = 2
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice this time, our file &lt;code&gt;err&lt;/code&gt; is only opened and truncated once, before the child process starts! The child process simply copies value of file descriptor &lt;code&gt;2&lt;/code&gt; to &lt;code&gt;1&lt;/code&gt;, which redirects &lt;code&gt;STDOUT&lt;/code&gt; to &lt;code&gt;STDERR&lt;/code&gt; and immediately writes output of &lt;code&gt;echo&lt;/code&gt; to &lt;code&gt;STDOUT&lt;/code&gt; (points to &lt;code&gt;err&lt;/code&gt; file at this point). Since there is no additional &lt;code&gt;openat()&lt;/code&gt; call, the &lt;code&gt;err&lt;/code&gt; file does not get truncated between two &lt;code&gt;echo&lt;/code&gt; calls!&lt;/p&gt;

&lt;p&gt;Intuitively, we can postulate that, when given a file path to redirect to, Linux will always attempt to open the file and assign a file descriptor to it, truncating the file in the process. But when redirecting with &lt;code&gt;&amp;gt;&amp;amp;&lt;/code&gt;, Linux simply copies file descriptor, without attempting to open again (a valid file descriptor should indicate that the file is open and ready for I/O).&lt;/p&gt;

&lt;p&gt;To verify this speculation, let&amp;rsquo;s try two commands and compare them:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;ls 1&amp;gt;&amp;amp;2&#39;

openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
dup2(2, 1)                              = 1
strace: Process 12024 attached
[pid 12024] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libselinux.so.1&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/libpcre2-8.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libpthread.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/proc/filesystems&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12024] openat(AT_FDCWD, &amp;quot;.&amp;quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3
[pid 12024] write(1, &amp;quot;anaconda3\tbin\t Documents  exampl&amp;quot;..., 119anaconda3	bin	 Documents  examples.desktop  learn_linux  NASA_APOD  output	R	      snap	 token.pickle  WorkGoogleDrive
) = 119
[pid 12024] write(1, &amp;quot;android-studio\tDesktop  Download&amp;quot;..., 120android-studio	Desktop  Downloads  go		      local	   OneDrive   Pictures	restore.spst  Templates  Videos        Zotero
) = 120
[pid 12024] write(1, &amp;quot;Apps\t\tdlang\t err\t    guix-instal&amp;quot;..., 89Apps		dlang	 err	    guix-install.sh   Music	   out	      Public	scripts       test	 vim
) = 89
[pid 12024] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=12024, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 1)                             = 1
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ strace -f -e trace=openat,write,dup2 sh -c &#39;ls &amp;gt;/dev/stderr&#39;

openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, &amp;quot;/dev/stderr&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3
dup2(3, 1)                              = 1
strace: Process 12080 attached
[pid 12080] openat(AT_FDCWD, &amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libselinux.so.1&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libc.so.6&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/usr/lib/x86_64-linux-gnu/libpcre2-8.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libdl.so.2&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/lib/x86_64-linux-gnu/libpthread.so.0&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/proc/filesystems&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_CLOEXEC) = 3
[pid 12080] openat(AT_FDCWD, &amp;quot;.&amp;quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3
[pid 12080] write(1, &amp;quot;anaconda3\tbin\t Documents  exampl&amp;quot;..., 119anaconda3	bin	 Documents  examples.desktop  learn_linux  NASA_APOD  output	R	      snap	 token.pickle  WorkGoogleDrive
) = 119
[pid 12080] write(1, &amp;quot;android-studio\tDesktop  Download&amp;quot;..., 120android-studio	Desktop  Downloads  go		      local	   OneDrive   Pictures	restore.spst  Templates  Videos        Zotero
) = 120
[pid 12080] write(1, &amp;quot;Apps\t\tdlang\t err\t    guix-instal&amp;quot;..., 89Apps		dlang	 err	    guix-install.sh   Music	   out	      Public	scripts       test	 vim
) = 89
[pid 12080] +++ exited with 0 +++
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=12080, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
dup2(10, 1)                             = 1
+++ exited with 0 +++
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Exactly what we predicted! We see that when redirected with &lt;code&gt;&amp;gt;&amp;amp;2&lt;/code&gt;, the function &lt;code&gt;openat(AT_FDCWD, &amp;quot;/dev/stderr&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666)&lt;/code&gt; is not called, while when redirected with &lt;code&gt;&amp;gt;/dev/stderr&lt;/code&gt;, it does get called.&lt;/p&gt;

&lt;h2 id=&#34;to-summarize&#34;&gt;To summarize&amp;hellip;&lt;/h2&gt;

&lt;p&gt;You should pretty much always use &lt;code&gt;&amp;gt;&amp;amp;&lt;/code&gt; instead of &lt;code&gt;/dev/stderr&lt;/code&gt; or &lt;code&gt;/dev/stdout&lt;/code&gt; when manipulating STDIO streams.
Although, I stumbled upon this Bash manual page:&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>How to run snakemake pipeline on HPC</title>
      <link>/post/how-to-run-snakemake-pipeline-on-hpc/</link>
      <pubDate>Thu, 17 Oct 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/how-to-run-snakemake-pipeline-on-hpc/</guid>
      <description>

&lt;h2 id=&#34;why-use-snakemake-on-hpc&#34;&gt;Why use Snakemake on HPC&lt;/h2&gt;

&lt;p&gt;Snakemake is a handy workflow manager written in Python. It handles workflow based on predefined job dependencies. One of the great features of Snakemake is that it can manage a workflow on both a standalone computer, or a clustered HPC system. HPC, or &amp;ldquo;cluster&amp;rdquo; as it&amp;rsquo;s often referred to, requires additional considerations.&lt;/p&gt;

&lt;p&gt;On HPC, all computing jobs should be submitted to &amp;ldquo;compute nodes&amp;rdquo; through a workload manager (for example, Slurm). Running jobs on &amp;ldquo;heaed nodes&amp;rdquo;, or log-in nodes, is a big no-no: doing so risks exhausting computing resources of head node computer (which is very limited) and slowing down everyone else on that same head node.&lt;/p&gt;

&lt;p&gt;File system is another thing that requires consideration when computing on HPC. Many HPC systems use NFS (Network File System) to have storage system accessible to all computing and head nodes. But some HPC systems also have dedicated local storage for each compute node. This is to help offload I/Os from major storage drives when users are running jobs with intensive I/O. It is important that users make use of these local storage spaces, as well as clean up their temporary files.&lt;/p&gt;

&lt;p&gt;Below I will show how to achieve responsible computing on HPC with a few tweaks to your Snakemake workflow.&lt;/p&gt;

&lt;h2 id=&#34;how-to-run-snakemake-on-hpc&#34;&gt;How to run snakemake on HPC&lt;/h2&gt;

&lt;p&gt;Snakemake natively supports managing job submission on HPC. Take a look at their &lt;a href=&#34;https://snakemake.readthedocs.io/en/stable/executable.html#cluster-execution&#34; target=&#34;_blank&#34;&gt;documentation here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s assume I have a Snakefile with following minimal rules:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;rule all:
    input: &amp;quot;RawData/Sample.fastq.gz&amp;quot;

rule compressFASTQ:
    input: &amp;quot;RawData/Sample.fastq&amp;quot;
    output: &amp;quot;RawData/Sample.fastq.gz&amp;quot;
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     gzip {input}
     &amp;quot;&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To execute this workflow locally, we can simply invoke &lt;code&gt;snakemake -s path/to/Snakefile&lt;/code&gt; (or &lt;code&gt;snakemake&lt;/code&gt; if you&amp;rsquo;re in the same directory as &lt;code&gt;Snakefile&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;Now if we want to run this on HPC on compute nodes, Snakemake allows us to do so by:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;snakemake -s Snakefile --cluster &#39;sbatch -t 60 --mem=2g -c 1&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the above command, we use &lt;code&gt;--cluster&lt;/code&gt; to hand Snakemake a command that it can use to submit a job script. Snakemake creates a job script for each job to be run and uses this command to submit that job to HPC. That simple!
Notice that here we use &lt;code&gt;sbatch&lt;/code&gt; because it&amp;rsquo;s the command you would use to submit a shell script on HPC managed by Slurm. Replace this with &lt;code&gt;qsub&lt;/code&gt; commands if your HPC uses SGE.&lt;/p&gt;

&lt;h2 id=&#34;decorate-your-job-submission&#34;&gt;Decorate your job submission&lt;/h2&gt;

&lt;h3 id=&#34;claim-different-resources-based-on-rules&#34;&gt;Claim different resources based on rules&lt;/h3&gt;

&lt;p&gt;Now suppose we have a slightly more complicated workflow:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;samples = [&#39;sample1&#39;, &#39;sample2&#39;, &#39;sample3&#39;, &#39;sample4&#39;]
rule all:
    input: expand(&amp;quot;Alignment/{sample}.bam&amp;quot;, sample = samples)

rule downloadFASTQ:
    output: &amp;quot;RawData/{sample}_1.fastq.gz&amp;quot;, &amp;quot;RawData/{sample}_2.fastq.gz&amp;quot;
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     ascp username@host:path/to/file/{wildcards.sample} RawData/
     &amp;quot;&amp;quot;&amp;quot;

rule mapFASTQ:
    input: 
        f1 = &amp;quot;RawData/{sample}_1.fastq.gz&amp;quot;, 
        f2 =&amp;quot;RawData/{sample}_2.fastq.gz&amp;quot;, 
        ref = &amp;quot;Ref/ref.fa&amp;quot;
    output: temp(&amp;quot;Alignment/{sample}.sam&amp;quot;)
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     bwa mem -R &amp;quot;@RG\\tID:{wildcards.sample}\\tSM:{wildcards.sample}&amp;quot; {input.ref} {input.f1} {input.f2} &amp;gt; {output}
     &amp;quot;&amp;quot;&amp;quot;

rule convertSAM:
    input: &amp;quot;Alignment/{sample}.sam&amp;quot;
    output: &amp;quot;Alignment/{sample}.bam&amp;quot;
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     samtools view -bh {input} &amp;gt; {output}
     &amp;quot;&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now in this workflow, different jobs require different computing resources: &lt;code&gt;mapFASTQ&lt;/code&gt; probably requires more RAM than &lt;code&gt;downloadFASTQ&lt;/code&gt; does. And more threads would probably speed up &lt;code&gt;mapFASTQ&lt;/code&gt; but change little to &lt;code&gt;downloadFASTQ&lt;/code&gt;. Using &lt;code&gt;--cluster&lt;/code&gt; like shown above will cause all jobs to request same amount of resources from HPC. How can we make Snakemake request different amount of resources based on each job?&lt;/p&gt;

&lt;p&gt;This can be easily achieved by two ways:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Define resources in rule parameters:&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The string following &lt;code&gt;--cluster&lt;/code&gt; can access all variables within a rule like we could do in a shell command within a rule. For example, we can define &lt;code&gt;rule mapFASTQ&lt;/code&gt; shown above as this instead:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;rule mapFASTQ:
    input: 
        f1 = &amp;quot;RawData/{sample}_1.fastq.gz&amp;quot;, 
        f2 =&amp;quot;RawData/{sample}_2.fastq.gz&amp;quot;, 
        ref = &amp;quot;Ref/ref.fa&amp;quot;
    output: temp(&amp;quot;Alignment/{sample}.sam&amp;quot;)
    threads: 8
    params: time = 120, mem = &amp;quot;8g&amp;quot;
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     bwa mem -@ {threads} -R &amp;quot;@RG\\tID:{wildcards.sample}\\tSM:{wildcards.sample}&amp;quot; {input.ref} {input.f1} {input.f2} &amp;gt; {output}
     &amp;quot;&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then we can revoke the workflow by:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;snakemake -s Snakefile --cluster &#39;sbatch -t {params.time} --mem={params.mem} -c {threads}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that you must define these params for all rules or you will get an error when Snakemake tries to submit a job from a rule that doesn&amp;rsquo;t have one or more of these params defined.&lt;/p&gt;

&lt;p&gt;Another more convinient way involves using a separate cluster config file:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Define resources in cluster.config:&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Instead of putting parameters for cluster submission into each individual rule, you can write a separate config file that contains these parameters:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;cluster.yaml&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;__default__:
  partition: &amp;quot;high&amp;quot;
  cpus: &amp;quot;{threads}&amp;quot;
  time: 60
  mem: &amp;quot;2g&amp;quot;

mapFASTQ:
  mem: &amp;quot;8g&amp;quot;
  time: 120
  
convertSAM:
  mem: &amp;quot;4g&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This file defines dafault parameters Snakemake will use for job submissions for all rules, &lt;em&gt;unless&lt;/em&gt; they are overridden by specific parameters defined below.&lt;/p&gt;

&lt;p&gt;Now in our rule definition, we only need to specify &lt;code&gt;threads&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;rule mapFASTQ:
    input: 
        f1 = &amp;quot;RawData/{sample}_1.fastq.gz&amp;quot;, 
        f2 =&amp;quot;RawData/{sample}_2.fastq.gz&amp;quot;, 
        ref = &amp;quot;Ref/ref.fa&amp;quot;
    output: temp(&amp;quot;Alignment/{sample}.sam&amp;quot;)
    threads: 8
    shell:
     &amp;quot;&amp;quot;&amp;quot;
     bwa mem -@ {threads} -R &amp;quot;@RG\\tID:{wildcards.sample}\\tSM:{wildcards.sample}&amp;quot; {input.ref} {input.f1} {input.f2} &amp;gt; {output}
     &amp;quot;&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The reason I keep &lt;code&gt;threads&lt;/code&gt; in rule definition is because when running on a local machine Snakemake can still utilize this paramter for multi-threading&lt;/p&gt;

&lt;p&gt;Then we can revoke by:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;snakemake -s Snakefile --cluster-config cluster.yaml --cluster &#39;sbatch -t {cluster.time} --mem={cluster.mem} -c {cluster.cpus}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;redirect-cluster-output&#34;&gt;Redirect cluster output&lt;/h3&gt;

&lt;p&gt;When running a job on cluster, stdout and stderr are not immediately obvious. Slurm managed systems redirect them to &lt;code&gt;slurm-JOBID.txt&lt;/code&gt; in working directory by default. This can be hard to tracked down when you&amp;rsquo;re using Snakemake to manage more than a few dozen jobs. Luckily, with Snakemake this can be very easily changed. Let&amp;rsquo;s modify out &lt;code&gt;cluster.yaml&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;__default__:
  partition: &amp;quot;high&amp;quot;
  cpus: &amp;quot;{threads}&amp;quot;
  time: 60
  mem: &amp;quot;2g&amp;quot;
  output: &amp;quot;logs_slurm/{rule}.{wildcards}.out&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then we revoke Snakemake by:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;snakemake -s Snakefile --cluster-config cluster.yaml --cluster &#39;sbatch -t {cluster.time} --mem={cluster.mem} -c {cluster.cpus} -o {cluster.output} -e {cluster.output}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This will redirect stdout and stderr of every job to their corresponding log files named as by rule and wildcards (eg. &lt;code&gt;downloadFASTQ.sample1.out&lt;/code&gt;) under &lt;code&gt;logs_slurm&lt;/code&gt; directory. If a particular job fails, it&amp;rsquo;s super easy to find its log file!&lt;/p&gt;

&lt;h3 id=&#34;email-notification-when-a-job-fails&#34;&gt;Email notification when a job fails&lt;/h3&gt;

&lt;p&gt;Often times it&amp;rsquo;s desirable to know when a job fails. You can have cluster notify you by email simply by modifying &lt;code&gt;cluster.yaml&lt;/code&gt; to include cluster params for email notifications. For example:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;__default__:
  partition: &amp;quot;high&amp;quot;
  cpus: &amp;quot;{threads}&amp;quot;
  time: 60
  mem: &amp;quot;2g&amp;quot;
  output: &amp;quot;logs_slurm/{rule}.{wildcards}.out&amp;quot;
  email: &amp;quot;user@host.com&amp;quot;
  email_type: &amp;quot;FAIL&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then revoke Snakemake with:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;snakemake -s Snakefile --cluster-config cluster.yaml --cluster &#39;sbatch -t {cluster.time} --mem={cluster.mem} -c {cluster.cpus} -o {cluster.output} -e {cluster.output} --mail-type {cluster.email_type} --mail-user {cluster.email}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;put-snakemake-command-in-a-scheduler-script&#34;&gt;Put Snakemake command in a &amp;ldquo;scheduler&amp;rdquo; script&lt;/h3&gt;

&lt;p&gt;Evidently, as our cluster config parameters grow, the command to revoke Snakemake also grows and it becomes tedious to type every time. To avoid this, you can simply put this command in a sbtach script like so:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;scheduler.sh&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#! /bin/bash -login
#SBATCH -J scheduler
#SBATCH -t 7-00:00:00
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 1  
#SBATCH -p high
#SBATCH --mem=2gb
#SBATCH --mail-type=ALL
#SBATCH --mail-user=user@host.com

cd /path/to/snakemake/piepeline

mkdir -p logs_slurm
snakemake -s Snakefile --cluster-config cluster.yaml --cluster &#39;sbatch -t {cluster.time} --mem={cluster.mem} -c {cluster.cpus} -o {cluster.output} -e {cluster.output} --mail-type {cluster.email_type} --mail-user {cluster.email}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then submit this script to cluster using &lt;code&gt;sbatch scheduler.sh&lt;/code&gt;. Then all you need to do is sit back and wait for it to finish (or error out).&lt;/p&gt;

&lt;h2 id=&#34;best-practice-on-cluster&#34;&gt;Best practice on cluster&lt;/h2&gt;

&lt;h3 id=&#34;use-local-temp-directory&#34;&gt;Use local temp directory&lt;/h3&gt;

&lt;p&gt;Because of the unique structures of HPC systems, many utilize local storage to speed up I/O intensive jobs. Therefore, whenever you have jobs that read/write (especially in small chunks) intensively to hard disks, you should try to have them I/O on these local storage and move your files once the job is finished.&lt;/p&gt;

&lt;p&gt;Suppose we have &lt;code&gt;/scratch/&lt;/code&gt; as local space for each node on our HPC system. Reading from and writing to &lt;code&gt;/scratch/&lt;/code&gt; will be significantly faster than any other directories. But you can&amp;rsquo;t access this space from any other nodes except this one, including your head node. Therefore you should always move your desired files afterwards. And these storage spaces are usually very limited (~1Tb), you should also always clean up after your job so others can make use of it as well.&lt;/p&gt;

&lt;p&gt;To utilize this space, in your bash script, define a cleanup function and call it upon exit:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export MYTMP=/scratch/$USER/$SLURM_JOBID
cleanup() {{ rm -rf $MYTMP; }}
trap cleanup EXIT
mkdir -p $MYTMP
... 

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the above code, we defined our temp directory inside &lt;code&gt;/scratch/&lt;/code&gt; using &lt;code&gt;$USER&lt;/code&gt; and &lt;code&gt;$SLURM_JOBID&lt;/code&gt;. This allows anyone, including yourself, to be able to know immediately which directory belongs to you and whether or not it is currently in use (depending on the state of associated job).&lt;/p&gt;

&lt;p&gt;You can add this code to your Snakefile whenever you use &lt;code&gt;shell&lt;/code&gt; directive. &lt;code&gt;trap&lt;/code&gt; keyword will ensure that &lt;code&gt;cleanup()&lt;/code&gt; function is always called to remove all temp files associated with a job whenever said job exits, either successfully or due to a failure.&lt;/p&gt;

&lt;h3 id=&#34;run-interactive-jobs-on-compute-nodes&#34;&gt;Run interactive jobs on compute nodes&lt;/h3&gt;

&lt;p&gt;When analyzing data, we often need to run commands interactively, either testing out commands before deploying at a large scale or run some preliminary data exploration and visualization through Rstudio or Jupyter Notebook. When working on HPC systems, a rule of thumb is to not run any jobs other than simple commands like &lt;code&gt;cp&lt;/code&gt;, &lt;code&gt;mv&lt;/code&gt;, &lt;code&gt;nano&lt;/code&gt;, etc on head nodes because head nodes usually have very limited resources and are not suitable for resource-intensive computing. To run commands interactively, you need to start an interactive job:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;srun -t 240 --mem=10g --pty bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This will request 10g RAM and 1 thread for 240 minutes (4 hours) to start an interactive bash shell. You can also use &lt;code&gt;--pty R&lt;/code&gt; and &lt;code&gt;--pty python&lt;/code&gt; to start R and Python shells respectively.&lt;/p&gt;

&lt;h3 id=&#34;run-rstudio-interactively-on-hpc&#34;&gt;Run RStudio interactively on HPC&lt;/h3&gt;

&lt;p&gt;I&amp;rsquo;m a big fan of RStudio for its user friendly interface and versatile functionality and I use R notebooks with RStudio for most of my data analysis work and I often run out of RAM on my PC for large data-set. Is it possible to move my RStudio workflow to HPC as well? Yes!&lt;/p&gt;

&lt;p&gt;First let&amp;rsquo;s install RStudio on HPC. I use conda but many other methods will do as well.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;conda create -n rstudio rstudio
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then fresh log in to HPC through ssh with X11 forwarding enabled:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh -X username@host
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can test X11 forwarding with your connection with &lt;code&gt;xclock&lt;/code&gt;. If it&amp;rsquo;s working, you should see an analog clock app pop up on your local machine.
Now we can start RStudio. &lt;em&gt;First request an interactive session&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;srun -t 240 --mem=10g --pty bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And start RStudio:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;conda activate rstudio
rstudio
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you should be able to use it on your local machine!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>What is ChROseq and how does it work</title>
      <link>/post/what-is-chroseq-and-how-does-it-work/</link>
      <pubDate>Sun, 11 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/what-is-chroseq-and-how-does-it-work/</guid>
      <description>

&lt;p&gt;At the moment of writing this post, I&amp;rsquo;m sitting on the plane flying to Cornell. There I will learn a beautiful technique called Chromatin Run-On and Sequencing, or ChRO-seq.&lt;/p&gt;

&lt;p&gt;Thirteen hours of travel is getting to the point of breaking my soul &amp;ndash; I have finished most of work I can comfortablely do with one screen on a samll laptop. So I decided to write down what I know so far about ChRO-seq in preparation for my upcoming training tomorrow. I will keep updating this post as I learn more about this technique.&lt;/p&gt;

&lt;h2 id=&#34;what-is-chroseq&#34;&gt;What is ChROseq&lt;/h2&gt;

&lt;p&gt;ChRO-seq is a variant of Run-On sequencing developed by Danko lab at Cornell (Chu et. al., 2018). In essence, it profiles nascent RNA by capturing RNA polII and DNA interaction. Below is a diagram from the authors depicting the major steps of a ChRO-seq experiment:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/ChROseq.png&#34; alt=&#34;Summary of ChROseq methods&#34; /&gt;&lt;/p&gt;

&lt;p&gt;As shown above, insoluble chromatin is first isolated from tissues or cell culture. Isolated chromatin then gets re-suspended through sonication. Run-on reaction is done by incubating RNA polII and DNA complex with biotinylated rNTP. A complementary biotinylated NTP gets added on to the attached nascent RNA and prevents any further elongation.&lt;/p&gt;

&lt;p&gt;Once run-on reaction is completed, 3 rounds of streptavidin bead purification are performed to purify extended nascent RNA, add 3&amp;rsquo; adapter, remove 5&amp;rsquo;cap and add 5&amp;rsquo; adapter. After adapters are added to both ends, a cDNA library is constructed from the nascent RNAs and a single end illumina sequencing is performed from 3&amp;rsquo;end.&lt;/p&gt;

&lt;h2 id=&#34;what-does-chro-seq-tell-me&#34;&gt;What does ChRO-seq tell me&lt;/h2&gt;

&lt;p&gt;Like any run-on sequencing techique, ChRO-seq precisely captures nascent RNA when compared to general RNAseq. This means that:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ChRO-seq gives a more accurate quantification of DNA transcription, as opposed to RNAseq, which describes a result of DNA transcription and RNA degradation.&lt;/li&gt;
&lt;li&gt;The fact that ChROseq is not noised by RNA degradation also means that it is able to capture many non-coding RNAs that have a short life span in cells and thus difficult for RNAseq to capture.&lt;/li&gt;
&lt;li&gt;ChRO-seq provides a snap shot of transcription activity. As revealed by other run-on sequencing, it can identify RNA polII pausing sites.&lt;/li&gt;
&lt;li&gt;Like other run-on sequencing, ChRO-seq can also be used to identify different types of transcriptions, as observed by Core et. al., 2008.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;what-does-chro-seq-not-tell-me&#34;&gt;What does ChRO-seq not tell me&lt;/h2&gt;

&lt;p&gt;Because ChRO-seq captures nascent RNA, naturally, it does not contain any post-transcriptional level information like splicing, polyadenylation, and other RNA or protein modifications.&lt;/p&gt;

&lt;h2 id=&#34;how-does-chro-seq-compare-to-other-rna-related-techniques&#34;&gt;How does ChRO-seq compare to other RNA-related techniques?&lt;/h2&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;RNAseq&lt;/th&gt;
&lt;th&gt;ChRO-seq&lt;/th&gt;
&lt;th&gt;PRO-seq&lt;/th&gt;
&lt;th&gt;GRO-seq&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;RNA captured&lt;/td&gt;
&lt;td&gt;mature RNA&lt;/td&gt;
&lt;td&gt;Nascent RNA&lt;/td&gt;
&lt;td&gt;Nascent RNA&lt;/td&gt;
&lt;td&gt;Nascent RNA&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Quantify transcription&lt;/td&gt;
&lt;td&gt;Yes(with degradation)&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Single base resolution&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;td&gt;Yes&lt;/td&gt;
&lt;td&gt;No&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Material type&lt;/td&gt;
&lt;td&gt;RNA&lt;/td&gt;
&lt;td&gt;Insoluble chromatin&lt;/td&gt;
&lt;td&gt;Nuclei&lt;/td&gt;
&lt;td&gt;Nuclei&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
</description>
    </item>
    
    <item>
      <title>EzProtocol</title>
      <link>/project/ezprotocol/</link>
      <pubDate>Fri, 09 Aug 2019 14:11:14 -0700</pubDate>
      
      <guid>/project/ezprotocol/</guid>
      <description>

&lt;p&gt;ezProtocol is a program designed for Opentrons OT2 robot. It handles writing detailed script for you so you can spend your time on things that matter. It can be found &lt;a href=&#34;https://github.com/SichongP/ezProtocol&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;ezProtocol can read protocol file in a format designed to be easy but versatile.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&#34;https://github.com/ucdavis/VGL_OT-2/blob/protocolWriter/dev/protocolWriter/How_to_write_a_protocol.md&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt; on how to make a protocol file.&lt;/p&gt;

&lt;h2 id=&#34;requirements&#34;&gt;Requirements&lt;/h2&gt;

&lt;p&gt;ezProtocol relies on below packages:
- PyYAML
- Pandas
- python-frontmatter
- regex
- opentrons&lt;/p&gt;

&lt;h2 id=&#34;installation-pip-deploy-pending&#34;&gt;Installation (pip deploy pending)&lt;/h2&gt;

&lt;p&gt;Clone this repo:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git clone https://github.com/SichongP/ezProtocol
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Change directory:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ezProtocol
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Install package:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pip install .
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Or&lt;/strong&gt;, use install.sh script:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;bash install.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Test installation:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ezprotocol -h
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;getting-started&#34;&gt;Getting started&lt;/h2&gt;

&lt;p&gt;Once you have protocol and deck layout file ready (see &lt;a href=&#34;https://github.com/ucdavis/VGL_OT-2/blob/protocolWriter/dev/protocolWriter/How_to_write_a_protocol.md&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt; for more detail on protocol and layout format), on commandline, type:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ezprotocol -p protocol.txt -d deck_layout.csv -o ot2_script.py
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Write scientific paper in markdown</title>
      <link>/post/2019-08-07-write-scientific-paper-in-markdown/</link>
      <pubDate>Wed, 07 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/2019-08-07-write-scientific-paper-in-markdown/</guid>
      <description>

&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;If you have ever written a scientific paper in MS Word (or any other word processing software) then you&amp;rsquo;re probably experienced frustrations like me: Word constantly crashing when loaded with too many high-resolution figures, citations getting messed up when working with others that use different citation managers, or hard to keep track of hundreds of versions of the draft, etc.&lt;/p&gt;

&lt;p&gt;Of course, Latex is always an excellent solution to all those problems. It separates content and formatting, allowing you to focus on content and leave the rest to those with expertise at it. A Tex file is also a pure text format so it&amp;rsquo;s easy to manage with a version control tool like git. However, Latex does have a rather steep learning curve. And a Tex file is not the most intuitive format to look at. For example, look at the below Tex format: &lt;img src=&#34;/img/Tex_example.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Another problem with writing in Latex is, while it&amp;rsquo;s not easy to learn Latex, it&amp;rsquo;s even harder to get all your collaborators on board, which is usually the case with scientific papers.&lt;/p&gt;

&lt;p&gt;That led me to think: markdown is a fantastic format that is both intuitive and powerful. Why not write in markdown? After a short search, I&amp;rsquo;m happy to report that this is indeed possible!&lt;/p&gt;

&lt;h2 id=&#34;what-does-writing-a-scientific-paper-require&#34;&gt;What does writing a scientific paper require?&lt;/h2&gt;

&lt;p&gt;Content aside, to write a scientific paper efficiently, one needs at least the following elements:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Easy way to insert and manage citations.&lt;/li&gt;
&lt;li&gt;Easy way to insert and manage high resolution figures&lt;/li&gt;
&lt;li&gt;Easy way to format tables&lt;/li&gt;
&lt;li&gt;Can be converted to other formats (pdf, html, etc)&lt;/li&gt;
&lt;li&gt;Allows collaborative writing&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Atom is an excellent text editor that with packages can do almost all of the above!&lt;/p&gt;

&lt;h2 id=&#34;required-software-and-packages&#34;&gt;Required software and packages&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://atom.io/&#34; target=&#34;_blank&#34;&gt;Atom&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://atom.io/packages/markdown-preview-enhanced&#34; target=&#34;_blank&#34;&gt;markdown-preview-enhanced&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://atom.io/packages/zotero-citations&#34; target=&#34;_blank&#34;&gt;zotero-citations&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://pandoc.org/&#34; target=&#34;_blank&#34;&gt;Pandoc&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://www.latex-project.org/get/&#34; target=&#34;_blank&#34;&gt;A Tex distribution for your OS&lt;/a&gt; (I used Tex Live for my linux system)&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://www.zotero.org/&#34; target=&#34;_blank&#34;&gt;Zotero citation manager&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://retorque.re/zotero-better-bibtex/installation/&#34; target=&#34;_blank&#34;&gt;Bbibtex Add-on&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Once you have all required packages installed, it&amp;rsquo;s time to start writing!&lt;/p&gt;

&lt;h2 id=&#34;write-a-paper&#34;&gt;Write a paper&lt;/h2&gt;

&lt;p&gt;Writing a paper in markdown is as easy as it sounds: use &lt;code&gt;#&lt;/code&gt; for titles and subtitles, use &lt;code&gt;|&lt;/code&gt; to format a table, among other things.&lt;/p&gt;

&lt;h3 id=&#34;write-math-equations&#34;&gt;Write math equations&lt;/h3&gt;

&lt;p&gt;You can use Latex syntax to write a math equation, like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$f_A^2+2f_Af_B+f_B^2=1$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;$f_A^2+2f_Af_B+f_B^2=1$&lt;/p&gt;

&lt;h3 id=&#34;import-figures&#34;&gt;Import figures:&lt;/h3&gt;

&lt;p&gt;You can insert a figure in typical markdown way:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;![alt text](figure.png)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This would import the figure at current location. You can even further configure the figure like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;![alt tex](figure.png){#id .class width=300px height=200px}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note: Because &lt;code&gt;markdown preview enhanced&lt;/code&gt; by default uses a different render engine to render the preview, you will not see change to figure size in the preview but it will be rendered when converting to another output. You can also change its default markdown render engine to pandoc to see size change in preview.&lt;/p&gt;

&lt;h3 id=&#34;insert-citations&#34;&gt;Insert citations:&lt;/h3&gt;

&lt;p&gt;In order to insert a citation, you need to have zotero open. With zotero open, you can call up zotero citation picker by either pressing &lt;code&gt;ctrl&lt;/code&gt; + &lt;code&gt;alt&lt;/code&gt; + &lt;code&gt;P&lt;/code&gt; or pressing &lt;code&gt;ctrl&lt;/code&gt; + &lt;code&gt;shift&lt;/code&gt; + &lt;code&gt;P&lt;/code&gt; to call up the command palate and search for &amp;ldquo;zotero citations: pick&amp;rdquo;. In the citation picker window like below: &lt;img src=&#34;/img/zotero_picker.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;type in the reference you wish to insert and hit &lt;code&gt;enter&lt;/code&gt;. A string of citation key should appear in your document:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@bryoisEvaluationChromatinAccessibility2018
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Surround this reference key with &lt;code&gt;[]&lt;/code&gt; and you&amp;rsquo;re good to go! Once you export this document to a pdf, word, or html format, the reference will be automatically appended to the end of your document and the ref key will be replaced with corresponding references, like so: &lt;img src=&#34;/img/citation_eg.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;To add multiple citations, use &lt;code&gt;;&lt;/code&gt; to separate ref keys, like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[@bintuSuperresolutionChromatinTracing2018; @bryoisEvaluationChromatinAccessibility2018]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Lastly, in order for pandoc to render citations correctly, you must provide a &lt;code&gt;bib&lt;/code&gt; file that contains all your citations and their corresponding ref keys.&lt;/p&gt;

&lt;p&gt;To do this, head on to zotero and click &lt;code&gt;File&lt;/code&gt; -&amp;gt; &lt;code&gt;Export library&lt;/code&gt;, in the format section, choose &lt;code&gt;Better Bibtex&lt;/code&gt;. If you want the exported library up to date with your zotero library, check &lt;code&gt;Keep updated&lt;/code&gt;. Once you have the exported library, add yaml frontmatter to the beginning of your document, like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;---
bibliography: My Library.bib
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;export-to-other-formats&#34;&gt;Export to other formats&lt;/h3&gt;

&lt;p&gt;With pandoc, you can easily convert the markdown format to other text formats like pdf, word, and tex. To do this, first add &lt;code&gt;output: word_document&lt;/code&gt; to your document&amp;rsquo;s frontmatter, like so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;---
bibliography: My Library.bib
output: word_document
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and then you can right clock on the preview panel on the right to export the document through pandoc: &lt;img src=&#34;/img/pandoc_right_click.png&#34; alt=&#34;&#34; /&gt; This will output your document to a Word document. To output to PDF, simple change the value of &lt;code&gt;output&lt;/code&gt; in frontmatter to &lt;code&gt;pdf_document&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h3&gt;

&lt;p&gt;Markdown is an incredibly intuitive text format and yet still versatile and powerful enough for productive writing. It has recently surged to new favorite of many among developers, scientists, and journalists. It will certainly keep raising in popularity due to its friendliness and expandability.&lt;/p&gt;

&lt;p&gt;Writing a scientific document in markdown has freed me of many frustrations caused by Word and with incredible &lt;code&gt;pandoc&lt;/code&gt;, I never have to wrestle with any of my collaborators over which text editor we are to use. It has been a life saver!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Hypothesis testing and multiple test correction</title>
      <link>/post/fdr-correction/</link>
      <pubDate>Thu, 11 Jul 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/fdr-correction/</guid>
      <description>


&lt;div id=&#34;why-multiple-testing-correction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Why multiple testing correction?&lt;/h2&gt;
&lt;p&gt;Multiple testing refers to a practice where we apply the same statistical test &lt;em&gt;independantly&lt;/em&gt; multiple times. This raises a problem that’s related to hypothesis testing: the more independant tests we do, the more inflated our false positive rate becomes. Here I’m gonna use a simple example to explain why multiple testing correction is crucial for hypothesis testing.&lt;/p&gt;
&lt;div id=&#34;an-example---are-you-being-cheated&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;An example - Are you being cheated?&lt;/h3&gt;
&lt;p&gt;Imagine that you’re playing a game where the host lets you flip a coin, if it’s a head, you get a point. If it’s a tail, the host gets a point. Whoever gets 20 points first wins the game. Does this sound like a fair game to you?&lt;/p&gt;
&lt;p&gt;In this scenario, when we say the game is “fair”, we are implying that the coin is an average, normal coin, which gives you 50/50 chance for a head or a tail. But is this true?&lt;/p&gt;
&lt;p&gt;Intuitively, we may find a coin that flips tail 10 times in a row quite suspicious. But what about 6 times in a row? 3 times? 9 out of 10 times? 3 out of 4 times? At which point do we decide to call it a fraud? Here is where hypothesis testing comes into play.&lt;/p&gt;
&lt;p&gt;When we look at this scenario, we first assume that coin is normal, which gives us an expectation: the percentages of heads and tails are roughly 50% each. Then we flip the coin multiple times, observe the frequency of heads and tails and make a decision based on our observed data: does it comply with our expectation or does it deviate so much that we feel safe to say that our assumption of fairness was wrong?&lt;/p&gt;
&lt;p&gt;The process above is essentially a hypothesis testing:
1. For a question, we formulate a null hypothesis and its alternative hypothesis
2. Based on our hypothesis, we draw some expectations of data assuming null hypothesis true
3. Carry out experiment, collect data and compare observed data to our expected data.
4. Make a decision - are we able to reject our null hypothesis or not?&lt;/p&gt;
&lt;p&gt;In the coin flip example, if we record 1 everytime we get a head and -1 everytime we get a tail, after many times of flips, we would expect to get a mean score of 0. Let’s simulate this process in R:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;flips = sample(c(-1,1), 20, replace = TRUE, prob = c(0.5, 0.5))
flips&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  [1] -1 -1  1 -1 -1 -1 -1  1 -1 -1 -1 -1  1  1 -1  1  1 -1 -1 -1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the above code, by setting &lt;code&gt;prob=c(0.5, 0.5)&lt;/code&gt;, we’re saying this is a fair coin. Now let’s see what the mean we got from this simulation is:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;mean(flips)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] -0.4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It’s not 0 as we expected it to be, even though we know we’re flipping a fair coin!
Now you probably know this is normal - The probability of getting 9 heads out of 20 flips is &lt;span class=&#34;math inline&#34;&gt;\(P_{9/20}=C_{20}^9(\frac{1}{2})^9(\frac{1}{2})^{11}=16%\)&lt;/span&gt;, not a very low chance at all! This is called sampling variablity.&lt;/p&gt;
&lt;p&gt;Therefore, just because observed data isn’t identical to our expected data, doesn’t mean we should reject our null hypothesis. Now how can we make this decision then?&lt;/p&gt;
&lt;p&gt;Let’s see if we do the same simulation over and over, what the mean looks like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;means=c()
for (i in c(1:1000))
{
  means = c(means, mean(sample(c(-1,1), 20, replace = TRUE, prob = c(0.5, 0.5))))
}
ggplot(data.frame(means)) + geom_histogram(aes(x=means), binwidth = 0.1)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-07-11-fdr-correction_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;It looks like a normal distribution (sort of)! This tells us that if we do the same experiment over and over again, the mean should follow a normal distribution and the majority of results should be near where the mean of this normal distribution (&lt;span class=&#34;math inline&#34;&gt;\(\mu=0\)&lt;/span&gt;) is. Is it possible that we get a mean of 0.6 from a fair coin? &lt;strong&gt;Yes, possible but not likely!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Of course, in reality we normally only run an experiment once and therefore, won’t get a distribution of means. But intuitively, we know if our mean is too far away from the center of this normal distribution, our true mean is probably not 0!&lt;/p&gt;
&lt;p&gt;In practice, we compare our sample mean to a &lt;em&gt;t&lt;/em&gt;-distribution. This is because our sample size is relatively small (20 flips) and there is some deviation from normal distribution when we calculate mean based on a small sample size. The shape of a &lt;em&gt;t&lt;/em&gt;-distribution depends on sample size, or degree of freedom (df):&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;x &amp;lt;- seq(-4, 4, length=100)
hx &amp;lt;- dnorm(x)

degf &amp;lt;- c(1, 3, 8, 30)
colors &amp;lt;- c(&amp;quot;red&amp;quot;, &amp;quot;blue&amp;quot;, &amp;quot;darkgreen&amp;quot;, &amp;quot;gold&amp;quot;, &amp;quot;black&amp;quot;)
labels &amp;lt;- c(&amp;quot;df=1&amp;quot;, &amp;quot;df=3&amp;quot;, &amp;quot;df=8&amp;quot;, &amp;quot;df=30&amp;quot;, &amp;quot;normal&amp;quot;)

plot(x, hx, type=&amp;quot;l&amp;quot;, lty=2, xlab=&amp;quot;x value&amp;quot;,
  ylab=&amp;quot;Density&amp;quot;, main=&amp;quot;Comparison of t Distributions&amp;quot;)

for (i in 1:4){
  lines(x, dt(x,degf[i]), lwd=2, col=colors[i])
}

legend(&amp;quot;topright&amp;quot;, inset=.05, title=&amp;quot;Distributions&amp;quot;,
  labels, lwd=2, lty=c(1, 1, 1, 1, 2), col=colors)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-07-11-fdr-correction_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;For our data from coin flips, we can perform a t-test, with the null hypothesis being that the true mean is zero:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;t.test(flips, mu = 0)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
##  One Sample t-test
## 
## data:  flips
## t = -1.9024, df = 19, p-value = 0.07239
## alternative hypothesis: true mean is not equal to 0
## 95 percent confidence interval:
##  -0.8400855  0.0400855
## sample estimates:
## mean of x 
##      -0.4&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the above output, we can see the result of the t-test: the p-value is 1. This means that if we assume null hypothesis (&lt;span class=&#34;math inline&#34;&gt;\(\mu=0\)&lt;/span&gt;), we can expect to see our data or more extreme with a probability of 1. This is as high as it gets, meaning we are very confident that we have a fair coin (as we know).&lt;/p&gt;
&lt;p&gt;Now what if the coin is slightly unbalanced?
Let’s say&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Haplotype, LD, and Association Tests</title>
      <link>/post/haplotype-ld-and-association-tests/</link>
      <pubDate>Thu, 21 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/haplotype-ld-and-association-tests/</guid>
      <description>

&lt;h1 id=&#34;table-of-content&#34;&gt;Table of content&lt;/h1&gt;

&lt;hr /&gt;

&lt;!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 --&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#table-of-content&#34;&gt;Table of content&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#what-are-haplotype-and-linkage-disequilibrium-ld&#34;&gt;What Are Haplotype and Linkage Disequilibrium (LD)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#quantify-ld&#34;&gt;Quantify LD&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#linkage-disequilibrium-coefficient-d&#34;&gt;Linkage Disequilibrium Coefficient ($D$):&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#standardized-linkage-disequilibrium-coefficient-d&#34;&gt;Standardized Linkage Disequilibrium Coefficient ($D&amp;rsquo;$)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#correlation-coefficient-gamma2&#34;&gt;Correlation coefficient ($\gamma^2$)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#now-why-do-we-care-about-ld-and-haplotype&#34;&gt;Now why do we care about LD and haplotype?&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#ld-is-an-indication-of-deviation-from-hardy-weinberg-equilibrium&#34;&gt;LD is an indication of deviation from Hardy-Weinberg equilibrium.&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;!-- /TOC --&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;em&gt;This is the first post of my QE prep series. I&amp;rsquo;ll be taking notes on my study for general knowledge section of my QE. I&amp;rsquo;m gonna start this off with my favorite topic in our GGG series classes: population genetics&lt;/em&gt;&lt;/p&gt;

&lt;h1 id=&#34;what-are-haplotype-and-linkage-disequilibrium-ld&#34;&gt;What Are Haplotype and Linkage Disequilibrium (LD)&lt;/h1&gt;

&lt;p&gt;To properly understand linkage disequilibrium, I want to go back to the &amp;ldquo;Dark Age&amp;rdquo; of genetics, when Gregor Mendel brilliantly discovered (Mendelian) laws of inheritance without any knowledge of the molecular basis.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The First Mendelian Law (Law of Segregation) states that each organism has two alleles for each trait and one of the two alleles is randomly passed on to an offspring during sexual reproduction.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;For example, an individual with an AB genotype is eqaully likely to pass an &lt;code&gt;A&lt;/code&gt; allele or a &lt;code&gt;B&lt;/code&gt; allele to its offspring (there are many assumption being made in this statement but I&amp;rsquo;ll roll with it for now).&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;The Second Mendelian Law (Law of Independent Assortment) states that alleles for different traits are passed on independantly from each other during sexual reproduction.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;For example, if allelea &lt;code&gt;A/a&lt;/code&gt; controls for trait 1 and alleles &lt;code&gt;B/b&lt;/code&gt; controls for trait 2 (assuming they are not at the same locus), then whether an individual passes on allele &lt;code&gt;A&lt;/code&gt; or &lt;code&gt;a&lt;/code&gt; is independent of wheter it passes on &lt;code&gt;B&lt;/code&gt; or &lt;code&gt;b&lt;/code&gt;. The Independent Assortment implicts the product rule:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Suppose an individual with &lt;code&gt;AaBb&lt;/code&gt; genotype (&lt;code&gt;Aa&lt;/code&gt; at locus 1 and &lt;code&gt;Bb&lt;/code&gt; at locus 2) mates with another individual with same &lt;code&gt;AaBb&lt;/code&gt; genotype, the probability of their offspring being &lt;code&gt;aabb&lt;/code&gt; is &lt;code&gt;1/16&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;In case you&amp;rsquo;re wondering how to get this number, here is my favorite way to calculate:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI0NDJweCIgaGVpZ2h0PSIzOTJweCIgdmlld0JveD0iLTAuNSAtMC41IDQ0MiAzOTIiPjxkZWZzLz48Zz48cmVjdCB4PSIxMzAiIHk9IjAiIHdpZHRoPSIxMjAiIGhlaWdodD0iNjAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNzQuNSwyMy41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIzMCIgaGVpZ2h0PSIxMiIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IHdpZHRoOiAzMHB4OyB3aGl0ZS1zcGFjZTogbm93cmFwOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5BYUJiPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE1IiB5PSIxMiIgZmlsbD0iIzAwMDAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIj5BYUJiPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIzMjAiIHk9IjAiIHdpZHRoPSIxMjAiIGhlaWdodD0iNjAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzNjQuNSwyMy41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIzMCIgaGVpZ2h0PSIxMiIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IHdpZHRoOiAzMHB4OyB3aGl0ZS1zcGFjZTogbm93cmFwOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5BYUJiPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE1IiB5PSIxMiIgZmlsbD0iIzAwMDAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIj5BYUJiPC90ZXh0Pjwvc3dpdGNoPjwvZz48cGF0aCBkPSJNIDE5MC4xNCA2MC4yOSBMIDE5MC4wMiAxMDMuNjMiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMTkwIDEwOC44OCBMIDE4Ni41MiAxMDEuODcgTCAxOTAuMDIgMTAzLjYzIEwgMTkzLjUyIDEwMS44OSBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzMuNSwxMTMuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OnZpc2libGU7IiBwb2ludGVyLWV2ZW50cz0iYWxsIiB3aWR0aD0iMzIiIGhlaWdodD0iMTIiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB3aWR0aDogMzJweDsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTppbmxpbmUtYmxvY2s7dGV4dC1hbGlnbjppbmhlcml0O3RleHQtZGVjb3JhdGlvbjppbmhlcml0OyI+QTogMS8yPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE2IiB5PSIxMiIgZmlsbD0iIzAwMDAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIj5BOiAxLzI8L3RleHQ+PC9zd2l0Y2g+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzNC41LDE1My41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIzMCIgaGVpZ2h0PSIxMiIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IHdpZHRoOiAzMXB4OyB3aGl0ZS1zcGFjZTogbm93cmFwOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5hOiAxLzI8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTUiIHk9IjEyIiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEycHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPmE6IDEvMjwvdGV4dD48L3N3aXRjaD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjA5LjUsMTUzLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlOyIgcG9pbnRlci1ldmVudHM9ImFsbCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjEyIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDMxcHg7IHdoaXRlLXNwYWNlOiBub3dyYXA7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6aW5saW5lLWJsb2NrO3RleHQtYWxpZ246aW5oZXJpdDt0ZXh0LWRlY29yYXRpb246aW5oZXJpdDsiPmI6IDEvMjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNSIgeT0iMTIiIGZpbGw9IiMwMDAwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTJweCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSI+YjogMS8yPC90ZXh0Pjwvc3dpdGNoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDguNSwxMTMuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OnZpc2libGU7IiBwb2ludGVyLWV2ZW50cz0iYWxsIiB3aWR0aD0iMzIiIGhlaWdodD0iMTIiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB3aWR0aDogMzJweDsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTppbmxpbmUtYmxvY2s7dGV4dC1hbGlnbjppbmhlcml0O3RleHQtZGVjb3JhdGlvbjppbmhlcml0OyI+QjogMS8yPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE2IiB5PSIxMiIgZmlsbD0iIzAwMDAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIj5COiAxLzI8L3RleHQ+PC9zd2l0Y2g+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMyNi41LDExMy41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIzMiIgaGVpZ2h0PSIxMiIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IHdpZHRoOiAzMnB4OyB3aGl0ZS1zcGFjZTogbm93cmFwOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5BOiAxLzI8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTYiIHk9IjEyIiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEycHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPkE6IDEvMjwvdGV4dD48L3N3aXRjaD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzI3LjUsMTUzLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlOyIgcG9pbnRlci1ldmVudHM9ImFsbCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjEyIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDMxcHg7IHdoaXRlLXNwYWNlOiBub3dyYXA7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6aW5saW5lLWJsb2NrO3RleHQtYWxpZ246aW5oZXJpdDt0ZXh0LWRlY29yYXRpb246aW5oZXJpdDsiPmE6IDEvMjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNSIgeT0iMTIiIGZpbGw9IiMwMDAwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTJweCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSI+YTogMS8yPC90ZXh0Pjwvc3dpdGNoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MDIuNSwxNTMuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OnZpc2libGU7IiBwb2ludGVyLWV2ZW50cz0iYWxsIiB3aWR0aD0iMzAiIGhlaWdodD0iMTIiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB3aWR0aDogMzFweDsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTppbmxpbmUtYmxvY2s7dGV4dC1hbGlnbjppbmhlcml0O3RleHQtZGVjb3JhdGlvbjppbmhlcml0OyI+YjogMS8yPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE1IiB5PSIxMiIgZmlsbD0iIzAwMDAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIj5iOiAxLzI8L3RleHQ+PC9zd2l0Y2g+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwMS41LDExMy41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIzMiIgaGVpZ2h0PSIxMiIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHZlcnRpY2FsLWFsaWduOiB0b3A7IHdpZHRoOiAzMnB4OyB3aGl0ZS1zcGFjZTogbm93cmFwOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5COiAxLzI8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTYiIHk9IjEyIiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEycHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPkI6IDEvMjwvdGV4dD48L3N3aXRjaD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC41LDEyMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6dmlzaWJsZTsiIHBvaW50ZXItZXZlbnRzPSJhbGwiIHdpZHRoPSIxMTgiIGhlaWdodD0iMzgiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxN3B4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyB2ZXJ0aWNhbC1hbGlnbjogdG9wOyB3aWR0aDogMTE4cHg7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgZm9udC13ZWlnaHQ6IGJvbGQ7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmlubGluZS1ibG9jazt0ZXh0LWFsaWduOmluaGVyaXQ7dGV4dC1kZWNvcmF0aW9uOmluaGVyaXQ7Ij5MYXcgb2YgU2VncmVnYXRpb248L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNTkiIHk9IjI4IiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE3cHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtd2VpZ2h0PSJib2xkIj5MYXcgb2YgU2VncmVnYXRpb248L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMzgwIDYwIEwgMzgwIDEwMy42MyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHBhdGggZD0iTSAzODAgMTA4Ljg4IEwgMzc2LjUgMTAxLjg4IEwgMzgwIDEwMy42MyBMIDM4My41IDEwMS44OCBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZWxsaXBzZSBjeD0iMTUwIiBjeT0iMTYwIiByeD0iMjIuNSIgcnk9IjE1LjAwMDAwMDAwMDAwMDAwMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmYwMDAwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxlbGxpcHNlIGN4PSIyMjUiIGN5PSIxNjAiIHJ4PSIyMi41IiByeT0iMTUuMDAwMDAwMDAwMDAwMDAyIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjAwMDAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGVsbGlwc2UgY3g9IjM0NSIgY3k9IjE2MCIgcng9IjIyLjUiIHJ5PSIxNS4wMDAwMDAwMDAwMDAwMDIiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmMDAwMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZWxsaXBzZSBjeD0iNDE1IiBjeT0iMTYwIiByeD0iMjIuNSIgcnk9IjE1LjAwMDAwMDAwMDAwMDAwMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmYwMDAwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMTUwIDE3NSBMIDE4NS43NyAyMTUuMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMTg5LjI2IDIxOS4xNiBMIDE4MS45OSAyMTYuMjYgTCAxODUuNzcgMjE1LjI0IEwgMTg3LjIyIDIxMS42MSBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDIyNC40MyAxNzQuNTcgTCAxOTMuODUgMjE0LjkyIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDE5MC42OCAyMTkuMTEgTCAxOTIuMTEgMjExLjQyIEwgMTkzLjg1IDIxNC45MiBMIDE5Ny42OSAyMTUuNjQgWiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGVsbGlwc2UgY3g9IjE5MCIgY3k9IjI0MCIgcng9IjMxLjQ5OTk5OTk5OTk5OTk5NiIgcnk9IjIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTY1LjUsMjMwLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlOyIgcG9pbnRlci1ldmVudHM9ImFsbCIgd2lkdGg9IjUyIiBoZWlnaHQ9IjE4IiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTdweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDUzcHg7IHdoaXRlLXNwYWNlOiBub3dyYXA7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6aW5saW5lLWJsb2NrO3RleHQtYWxpZ246aW5oZXJpdDt0ZXh0LWRlY29yYXRpb246aW5oZXJpdDsiPmFiOiAxLzQ8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMjYiIHk9IjE4IiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE3cHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPmFiOiAxLzQ8L3RleHQ+PC9zd2l0Y2g+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDguNSwxOTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OnZpc2libGU7IiBwb2ludGVyLWV2ZW50cz0iYWxsIiB3aWR0aD0iMTE4IiBoZWlnaHQ9IjU4IiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTdweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDExOHB4OyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7IGZvbnQtd2VpZ2h0OiBib2xkOyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTppbmxpbmUtYmxvY2s7dGV4dC1hbGlnbjppbmhlcml0O3RleHQtZGVjb3JhdGlvbjppbmhlcml0OyI+TGF3IG9mIEluZGVwZW5kZW50IEFzc29ydG1lbnTCoDwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI1OSIgeT0iMzgiIGZpbGw9IiMwMDAwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTdweCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC13ZWlnaHQ9ImJvbGQiPltOb3Qgc3VwcG9ydGVkIGJ5IHZpZXdlcl08L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMzQ1IDE3NSBMIDM4MC43NyAyMTUuMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMzg0LjI2IDIxOS4xNiBMIDM3Ni45OSAyMTYuMjYgTCAzODAuNzcgMjE1LjI0IEwgMzgyLjIyIDIxMS42MSBaIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDQxOS43NiAxNzQuNDcgTCAzODguODYgMjE0Ljk0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDM4NS42OCAyMTkuMTEgTCAzODcuMTQgMjExLjQyIEwgMzg4Ljg2IDIxNC45NCBMIDM5Mi43MSAyMTUuNjcgWiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGVsbGlwc2UgY3g9IjM4NSIgY3k9IjI0MCIgcng9IjMxLjQ5OTk5OTk5OTk5OTk5NiIgcnk9IjIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzU5LjUsMjMwLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlOyIgcG9pbnRlci1ldmVudHM9ImFsbCIgd2lkdGg9IjUyIiBoZWlnaHQ9IjE4IiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTdweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDUzcHg7IHdoaXRlLXNwYWNlOiBub3dyYXA7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6aW5saW5lLWJsb2NrO3RleHQtYWxpZ246aW5oZXJpdDt0ZXh0LWRlY29yYXRpb246aW5oZXJpdDsiPmFiOiAxLzQ8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMjYiIHk9IjE4IiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE3cHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPmFiOiAxLzQ8L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMTkxLjUgMjYwIEwgMjc1LjI4IDMzNS43MyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHBhdGggZD0iTSAyNzkuMTcgMzM5LjI1IEwgMjcxLjYzIDMzNy4xNSBMIDI3NS4yOCAzMzUuNzMgTCAyNzYuMzIgMzMxLjk2IFoiIGZpbGw9IiMwMDAwMDAiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMzg1IDI2MCBMIDI4NS4wNyAzMzYuMTQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMjgwLjg5IDMzOS4zMiBMIDI4NC4zNCAzMzIuMyBMIDI4NS4wNyAzMzYuMTQgTCAyODguNTggMzM3Ljg2IFoiIGZpbGw9IiMwMDAwMDAiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxlbGxpcHNlIGN4PSIyODAiIGN5PSIzNjUiIHJ4PSI2MC4wMDAwMDAwMDAwMDAwMSIgcnk9IjI1IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjM5LjUsMzU1LjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzp2aXNpYmxlOyIgcG9pbnRlci1ldmVudHM9ImFsbCIgd2lkdGg9IjgxIiBoZWlnaHQ9IjE4IiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTdweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgdmVydGljYWwtYWxpZ246IHRvcDsgd2lkdGg6IDgycHg7IHdoaXRlLXNwYWNlOiBub3dyYXA7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6aW5saW5lLWJsb2NrO3RleHQtYWxpZ246aW5oZXJpdDt0ZXh0LWRlY29yYXRpb246aW5oZXJpdDsiPmFhYmI6IDEvMTY8L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNDEiIHk9IjE4IiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE3cHgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiPmFhYmI6IDEvMTY8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48L3N2Zz4=&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;In the above diagram, first step involves the Law of Segregation, by which I calculated the probability of each gamete containing each allele separately. The second step is where the Law of Independent Assortment comes into play: The probability of each combination of two alleles is the product of the probabilities of each allele (in one gamete). And the last step is just random combination of two gametes (for a diploid organism).&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;However, just as every law has an exception, it was discovered that many of traits in various species didn&amp;rsquo;t really follow the Law of Independent Assortment. The following example shows a case of &amp;ldquo;dependent assortment&amp;rdquo;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Sweet peas have purple (&lt;code&gt;P&lt;/code&gt;) or red (&lt;code&gt;p&lt;/code&gt;) flowers and long (&lt;code&gt;L&lt;/code&gt;) or short (&lt;code&gt;l&lt;/code&gt;) pollen grains. Peas from two pure lines (&lt;code&gt;PPLL&lt;/code&gt; and &lt;code&gt;ppll&lt;/code&gt;) were crossed. The offspring (F1) are all purple flower and long grain (PpLl). They are then self crossed (&lt;code&gt;PpLl&lt;/code&gt; X &lt;code&gt;PpLl&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;Assuming indenpendent assortment, we expect to observe all 4 phenotypes in F2 with the following frequencies:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Phenotype&lt;/th&gt;
&lt;th&gt;Frequency&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Purple (P&lt;em&gt;), Long (L&lt;/em&gt;)&lt;/td&gt;
&lt;td&gt;&lt;sup&gt;9&lt;/sup&gt;&amp;frasl;&lt;sub&gt;16&lt;/sub&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Purple (P_), Short (ll)&lt;/td&gt;
&lt;td&gt;&lt;sup&gt;3&lt;/sup&gt;&amp;frasl;&lt;sub&gt;16&lt;/sub&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Red (pp), Long (L_)&lt;/td&gt;
&lt;td&gt;&lt;sup&gt;3&lt;/sup&gt;&amp;frasl;&lt;sub&gt;16&lt;/sub&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Red (pp), Short (ll)&lt;/td&gt;
&lt;td&gt;&lt;sup&gt;1&lt;/sup&gt;&amp;frasl;&lt;sub&gt;16&lt;/sub&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;However, large deviations from expected phenotype frequency were observed:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Phenotype&lt;/th&gt;
&lt;th&gt;Exp. Count&lt;/th&gt;
&lt;th&gt;Obs. Count&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Purple, Long (P_L_)&lt;/td&gt;
&lt;td&gt;216&lt;/td&gt;
&lt;td&gt;284&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Purple, Short (P_ll)&lt;/td&gt;
&lt;td&gt;72&lt;/td&gt;
&lt;td&gt;21&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Red, Long (ppL_)&lt;/td&gt;
&lt;td&gt;72&lt;/td&gt;
&lt;td&gt;21&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Red, Short (ppll)&lt;/td&gt;
&lt;td&gt;24&lt;/td&gt;
&lt;td&gt;55&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;em&gt;Data from Bateson et al.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;We know that in the parent line (&lt;code&gt;PPLL x ppll&lt;/code&gt;) &lt;code&gt;P&lt;/code&gt; and &lt;code&gt;L&lt;/code&gt; as well as &lt;code&gt;p&lt;/code&gt; and &lt;code&gt;l&lt;/code&gt; are always together because they are both homozygotes. But as the Mendel&amp;rsquo;s second law predicts, they should&amp;rsquo;ve independently assorted from F1 to F2. We, however, see that instead of random combination, &lt;code&gt;P&lt;/code&gt; still appear more often together with &lt;code&gt;L&lt;/code&gt; and so does &lt;code&gt;p&lt;/code&gt; and &lt;code&gt;l&lt;/code&gt;. It&amp;rsquo;s as if &lt;code&gt;P&lt;/code&gt; and &lt;code&gt;L&lt;/code&gt; were somehow linked. This phenomenon is termed &lt;a href=&#34;https://en.wikipedia.org/wiki/Genetic_linkage&#34; target=&#34;_blank&#34;&gt;&lt;code&gt;Linkage&lt;/code&gt;&lt;/a&gt;. We now know that this is because the two loci are closeby on the same chromsome and that during &lt;a href=&#34;https://en.wikipedia.org/wiki/Meiosis&#34; target=&#34;_blank&#34;&gt;meiosis&lt;/a&gt;, DNA on one chromsome are largely segregated together (except some &lt;a href=&#34;https://en.wikipedia.org/wiki/Genetic_recombination&#34; target=&#34;_blank&#34;&gt;recombination&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;When two loci are linked, product rule no longer applies. This causes a non-random association of alleles at different loci in a &lt;strong&gt;given population&lt;/strong&gt;. This is termed &lt;code&gt;Linkage Disequilibrium&lt;/code&gt; or &lt;code&gt;LD&lt;/code&gt;. (Technically LD does not always mean physical linkage. More on this later.)&lt;/p&gt;

&lt;p&gt;When we talk about linkage, knowing genotype of an individual alone is no longer enough: we wish to know which alleles are &amp;ldquo;linked&amp;rdquo; or belong to the same chromsome. In genetics, we call alleles that are on the same chromsome and likely to be inherited together a haplotype. For example, an individual with a &lt;code&gt;PpLl&lt;/code&gt; genotype may have these different haplotypes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;PL&lt;/code&gt; and &lt;code&gt;pl&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Pl&lt;/code&gt; and &lt;code&gt;pL&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;quantify-ld&#34;&gt;Quantify LD&lt;/h1&gt;

&lt;p&gt;There are several different ways to quntify the extent of linkage between any &lt;strong&gt;two&lt;/strong&gt; loci:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Coefficient of Linkage Disequilibrium (D)&lt;/li&gt;
&lt;li&gt;Normalized coefficient of Linkage Disequilibrium (D&amp;rsquo;)&lt;/li&gt;
&lt;li&gt;Correlation coefficient ($r^2$) and $\chi^2$ test&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I&amp;rsquo;ll briefly go over them below.&lt;/p&gt;

&lt;h2 id=&#34;linkage-disequilibrium-coefficient-d&#34;&gt;Linkage Disequilibrium Coefficient ($D$):&lt;/h2&gt;

&lt;p&gt;As mentioned before, if two loci are independent, their frequencies follow product rule:&lt;/p&gt;

&lt;p&gt;For two independent loci A and B, each with two alleles ($A_1$, $A_2$ and $B_1$, $B_2$, respectively), we have:
    $$f_{A_1B_1} = f_{A_1}f_{B_1}$$
   Now if A and B are not independent, this equation no longer stands true. In that case we have:
    $$f_{A_1B_1} = f_{A_1}f_{B_1} + D$$
  Here we have D as a &lt;em&gt;measurement&lt;/em&gt; of the extent of linkage disequilibrium between $A_1$ and $B_1$. We can calculate the same for all 4 haplotypes:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;A&lt;/th&gt;
&lt;th&gt;$A_1$&lt;/th&gt;
&lt;th&gt;$A_2$&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;frequency&lt;/td&gt;
&lt;td&gt;$f_{A_1}$&lt;/td&gt;
&lt;td&gt;$f_{A_2}$&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$B_1$&lt;/td&gt;
&lt;td&gt;$f_{B_1}$&lt;/td&gt;
&lt;td&gt;$f_{A_1}f_{B_1} + D_{A_1B_1}$&lt;/td&gt;
&lt;td&gt;$f_{A_2}f_{B_1} + D_{A_2B_1}$&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$B_2$&lt;/td&gt;
&lt;td&gt;$f_{B_2}$&lt;/td&gt;
&lt;td&gt;$f_{A_1}f_{B_2} + D_{A_1B_2}$&lt;/td&gt;
&lt;td&gt;$f_{A_2}f_{B_2} + D_{A_2B_2}$&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Solve above equations and we get:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$D_{A_1B_1} = f_{A_1B_1} - f_{A_1}f_{B_1}$&lt;/p&gt;

&lt;p&gt;$D_{A_1B_2} = f_{A_1B_2} - f_{A_1}f_{B_2}$&lt;/p&gt;

&lt;p&gt;$D_{A_2B_1} = f_{A_2B_1} - f_{A_2}f_{B_1}$&lt;/p&gt;

&lt;p&gt;$D_{A_2B_2} = f_{A_2B_2} - f_{A_2}f_{B_2}$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;For a given population, we have&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$f_{A_1} + f_{A_2} = 1$&lt;/p&gt;

&lt;p&gt;$f_{B_1} + f_{B_2} = 1$&lt;/p&gt;

&lt;p&gt;$f_{A_1B_1} + f_{A_1B_2} = f_{A_1}$&lt;/p&gt;

&lt;p&gt;$f_{A_1B_1} + f_{A_2B_1} = f_{B_1}$&lt;/p&gt;

&lt;p&gt;$f_{A_2B_1} + f_{A_2B_2} = f_{A_2} = 1 - f_{A_1}$&lt;/p&gt;

&lt;p&gt;$f_{A_1B_2} + f_{A_2B_2} = f_{B_2} = 1 - f_{B_1}$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;We can then further derive above equations:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$D_{A_2B_2} \\\ = f_{A_2B_2} - (1 - f_{A_1})(1 - f_{B_1})
 \\\\ = 1 - f_{B_1} - f_{A_1B_2} - (1 - f_{A_1})(1 - f_{B_1}) \\\ = 1 - f_{B_1} - f_{A_1} - f_{A_1B_1} - (1 - f_{A_1})(1 - f_{B_1}) \\\ = 1 - f_{B_1} - f_{A_1} + f_{A_1B_1} - 1 + f_{B_1} + f_{A_1} - f_{A_1}f_{B_1} \\\ = f_{A_1B_1} - f_{A_1}f_{B_1} = D_{A_1B_1}$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Similarly we can prove that $D_{A_1B_1} = - D_{A_1B_2} = - D_{A_2B_1} = D_{A_2B_2} = D$ (note that this is only true for diallelic loci. For loci with more than two alleles, we need to calculate D for each allele pair separately.)&lt;/p&gt;

&lt;p&gt;This makes sense because linkage disequilibrium should be a measurement of two loci not any two specific alleles in those loci. Therefore the D for any haplotype between the two given loci should be the same (or at least the absolute value of it).
We then have:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$D = D_{A_1B_1} = f_{A_1B_1} - f_{A_1}f_{B_1}$&lt;/p&gt;

&lt;p&gt;$D = -D_{A_1B_2} = -f_{A_1B_2} + f_{A_1}f_{B_2}$&lt;/p&gt;

&lt;p&gt;$D = -D_{A_2B_1} = -f_{A_2B_1} + f_{A_2}f_{B_1}$&lt;/p&gt;

&lt;p&gt;$D = D_{A_2B_2} = f_{A_2B_2} - f_{A_2}f_{B_2}$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Next we can prove that $D = f_{A_1B_1}f_{A_2B_2} - f_{A_1B_2}f_{A_2B_1}$:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$f_{A_1B_1}f_{A_2B_2} \\\ = (f_{A_1}f_{B_1} + D)(f_{A_2}f_{B_2} + D) \\\ = f_{A_1}f_{A_2}f_{B_1}f_{B_2} + D(f_{A_1}f_{B_1} + f_{A_2}f_{B_2}) + D^2$&lt;/p&gt;

&lt;p&gt;$f_{A_1B_2}f_{A_2B_1} \\\ = (f_{A_1}f_{B_2} - D)(f_{A_2}f_{B_1} - D) \\\ = f_{A_1}f_{A_2}f_{B_1}f_{B_2} - D(f_{A_1}f_{B_2} + f_{A_2}f_{B_1}) + D^2$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Taske substraction:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$f_{A_1B_1}f_{A_2B_2} - f_{A_1B_2}f_{A_2B_1} \\\ = f_{A_1}f_{A_2}f_{B_1}f_{B_2} + D(f_{A_1}f_{B_1} + f_{A_2}f_{B_2}) + D^2 - (f_{A_1}f_{A_2}f_{B_1}f_{B_2} - D(f_{A_1}f_{B_2} + f_{A_2}f_{B_1}) + D^2) \\\ = D(f_{A_1}f_{B_1} + f_{A_2}f_{B_2} + f_{A_1}f_{B_2} + f_{A_2}f_{B_1}) = D * 1 = D$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now we have a measure of linkage disequilibrium. By definition, we know that $D=0$ indicates independent loci (no linkage). What should the maxium value of D be?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Say we have a population with following genotype frequency:
  $f_{A_1} = f_{A_2} = 0.5 \\\ f_{B_1} = f_{B_2} = 0.5$&lt;/p&gt;

&lt;p&gt;Suppose there is complete linkage between $A_1$ and $B_1$, meaning we have following haplotype frequencies:
  $f_{A_1B_1} = f_{A_2B_2} = 0.5 \\\ f_{A_1B_2} = f_{A_2B_1} = 0$&lt;/p&gt;

&lt;p&gt;We can then calculate $D = f_{A_1B_1}f_{A_2B_2} - f_{A_1B_2}f_{A_2B_1} = 0.5 * 0.5 - 0 = 0.25$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When two loci are in complete linkage, we have $D=0.25$.
For any two loci, we always have $D \in [-0.25,0.25]$.&lt;/p&gt;

&lt;p&gt;This scale is not very intuitive but we can work with it. Now next question is, does equal $D$ mean equal linkage disequilibrium?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Consider the following two populations:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Pop 1 has haplotype frequencies as follow: $$f_{A_1B_1} = f_{A_2B_2} = 0.34 \\\ f_{A_1B_2} = f_{A_2B_1} = 0.16$$
We can calculate $D = 0.34^2 - 0.16^2 = 0.09$&lt;/li&gt;
&lt;li&gt;Pop 2 has haplotype frequencies as follow: $$f_{A_1B_1} = 0.9 \\\ f_{A_2B_2} = 0.1 \\\ f_{A_1B_2} = f_{A_2B_1} = 0$$
We can calculate $D = 0.9 * 0.1 - 0 = 0.09$&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;

&lt;p&gt;Even though $D$ at these loci for both populations is exactly the same, we can clearly see that pop 2 has comlete linkage between these two loci while pop 1 does not.&lt;/p&gt;

&lt;p&gt;This example shows a major problem of $D$ for measuring linkage disequilibrium: It&amp;rsquo;s ignorant of allele frequencies in a given population.&lt;/p&gt;

&lt;h2 id=&#34;standardized-linkage-disequilibrium-coefficient-d&#34;&gt;Standardized Linkage Disequilibrium Coefficient ($D&amp;rsquo;$)&lt;/h2&gt;

&lt;p&gt;To address this problem, we can standardize $D$ against allele frequency:
  $$D&amp;rsquo; = \frac{D}{D_{max}}$$&lt;/p&gt;

&lt;p&gt;$D_{max}$ is the maxium possible $D$ in a population with same allele frequencies (but different haplotype frequencies). We have $$D_{max} = f_{maxA_1B_1} - f_{A_1}f_{B_1} \\\ = min(f_{A_1},f_{B_1}) - f_{A_1}f_{B_1}$$
&lt;em&gt;We can also prove that for every haplotype between two given loci, we can get the same $D&amp;rsquo;$.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;For example, in the above two populations:&lt;/p&gt;

&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Pop 1: $$f_{A_1} = f_{A_2} = f_{B_1} = f_{B_2} = 0.5 \\\ D_{max} = 0.5 - 0.5 * 0.5 = 0.25 \\\ D&amp;rsquo; = \frac{D}{D_{max}} = \frac{0.09}{0.25} = \frac{9}{25} $$&lt;/li&gt;
&lt;li&gt;Pop 2: $$f_{A_1} = f_{B_1} = 0.9 \\\ f_{A_2} = f_{B_2} = 0.1 \\\ D_{max} = 0.9 - 0.9 * 0.9 = 0.09 \\\ D&amp;rsquo; = \frac{D}{D_{max}} = \frac{0.09}{0.09} = 1$$&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now we can see that $D&amp;rsquo;$ for population 2 is much higher than that of population 1, indicating a much higher linkage disequilibrium between these loci in pop 2. By definition, we know $D&amp;rsquo; \in [0,1]$&lt;/p&gt;

&lt;p&gt;However, $D&amp;rsquo;$ also has its own problem. Consider the following scenario:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Suppose we genotyped 100 individuals in a population, and count occurrance of each haplotype between loci A and B as follow:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Count&lt;/th&gt;
&lt;th&gt;Total&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;$A_1B_1$&lt;/td&gt;
&lt;td&gt;50&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_1B_2$&lt;/td&gt;
&lt;td&gt;49&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_2B_1$&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_2B_2$&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;We can get haplotype and allele frequencies:
  $$f_{A_1B_1} = 0.5, f_{A_1B_2} = 0.49 \\\ f_{A_2B_1} = 0, f_{A_2B_2} = 0.01 \\\ f_{A_1} = 0.99, f_{A_2} = 0.01 \\\ f_{B_1} = 0.5, f_{B_2} = 0.5$$
And calculate $D&amp;rsquo;$:
  $$D&amp;rsquo; = \frac{f_{A_1B_1} * f_{A_2B_2} - f_{A_1B_2} * f_{A_2B_1}}{min(f_{A_1}, f_{B_1}) - f_{A_1}f_{B_1}} = \frac{0.5 * 0.01 - 0.49 * 0}{0.5 - 0.5 * 0.99} = 1$$&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;In this case, $D&amp;rsquo;$ indicates strong linkage between the two loci. However, looking at data, we can&amp;rsquo;t confidently make any conclusions regarding the linkage between the two loci. The reason is that in all samples but one, they have either $A_1B_1$ or $A_1B_2$ haplotype. The only one that has an $A_2$ allele can simply be a result of a spontaneous mutaion rather than inheriting from a parent &lt;strong&gt;We do not have enough information to say whether or not A locus is linked with B locus because $A_2$ is mostly missing from data.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;In other words, $D&amp;rsquo;$ does not tell us how significant a linkage is or how confident we are in decalring a linkage disequilibrium. For this purpose, we turn to Pearson&amp;rsquo;s correlation coefficient.&lt;/p&gt;

&lt;h2 id=&#34;correlation-coefficient-gamma-2&#34;&gt;Correlation coefficient ($\gamma^2$)&lt;/h2&gt;

&lt;p&gt;Consider the population above:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Count&lt;/th&gt;
&lt;th&gt;Total&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;$A_1B_1$&lt;/td&gt;
&lt;td&gt;50&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_1B_2$&lt;/td&gt;
&lt;td&gt;49&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_2B_1$&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;$A_2B_2$&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;We calculated that $D=0.005$, now instead of  standardizing it like what we did with $D&amp;rsquo;$, we try a different approach:
  $$\gamma^2 = \frac{D^2}{f_{A_1}f_{A_2}f_{B_1}f_{B_2}}$$&lt;/p&gt;

&lt;p&gt;We have $\gamma^2 = \frac{0.005^2}{0.99 * 0.01 * 0.5 * 0.5} = 0.01$&lt;/p&gt;

&lt;p&gt;Now this seems to align well with our assessment of the data! As a matter of fact, this is actually the correlation coefficient of the two variables in this population!&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s arbitratrily assign 1 to an $A_1$ allele and -1 to an $A_2$ allele. And 1 to $B_1$, -1 to $B_2$. Now we can plot the data and calculate $\gamma$:&lt;/p&gt;




  

&lt;figure&gt;

&lt;img src=&#34;/img/QE1_corrPlot.jpeg&#34; /&gt;



&lt;figcaption data-pre=&#34;Figure &#34; data-post=&#34;:&#34; &gt;
  &lt;h4&gt;Correlation plot&lt;/h4&gt;
  
&lt;/figcaption&gt;

&lt;/figure&gt;

&lt;p&gt;In the above plot we have $R=0.1$ this is exactly what we calculated above ($\gamma^2 = 0.01$)! Now that we have a correlation coefficient, we can use a $\chi^2$ test on our dataset:&lt;/p&gt;

&lt;p&gt;$$\chi_S^2=\gamma^2*N=0.01*100=1\\\ P(\chi^2&amp;gt;\chi_S^2, df=1) = 0.317 $$&lt;/p&gt;

&lt;p&gt;The p-value is also shown in the above plot. Clearly, we don&amp;rsquo;t see a significant correlation (i.e linkage) between the two loci.&lt;/p&gt;

&lt;p&gt;This is the beauty of $\gamma^2$: it not only tells us the strength of a linkage ($\gamma^2$) but only indicates confidence in such linkage given data ($\chi^2$)!&lt;/p&gt;

&lt;p&gt;Now remember, &lt;strong&gt;the absence of significance is NOT evidence of insignificance!&lt;/strong&gt; Look at the above figure and we notice that the confidence interval of the plot is very large towards $x=-1$. This is because we have only a single data point at $x=-1$. This could easily be a sampling error or like mentioned above, a spontaneous mutation. It is possible, that there are more individuals with $A_2$ allele but we just didn&amp;rsquo;t include them in our samples for unknown reasons. In this case, since we can&amp;rsquo;t estimate frequencies of $A_2$ in haplotype $A_2B_1$ or $A_2B_2$, we can&amp;rsquo;t conclude with any confidence whether or not there is linkage between the two loci.&lt;/p&gt;

&lt;h1 id=&#34;now-why-do-we-care-about-ld-and-haplotype&#34;&gt;Now why do we care about LD and haplotype?&lt;/h1&gt;

&lt;h2 id=&#34;ld-is-an-indication-of-deviation-from-hardy-weinberg-equilibrium&#34;&gt;LD is an indication of deviation from Hardy-Weinberg equilibrium.&lt;/h2&gt;
</description>
    </item>
    
    <item>
      <title>Split a FASTA record by Ns</title>
      <link>/post/split-a-fasta-record-by-ns/</link>
      <pubDate>Wed, 20 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/split-a-fasta-record-by-ns/</guid>
      <description>&lt;p&gt;I want to split sequences in a fasta file at Ns.&lt;/p&gt;

&lt;p&gt;Here is what an example file looks like:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;1_name
ACGTTGCGGCATTCGATCGACGATCGATGCAAACGGTCACGGACTGACTGT
ACACACGTAGCAGCATCAGCATNNNNNNNNNNNNNNNNNNNNGTTGGACGG
NNNNNNNNNNNNGGTGACACACGAGATATATFAGATCAACGTAAGGGATGA
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
AGTCGCTAGCATGCATGGCATATACGCGATCGATTCGATAGCTAGCGNNNN
&amp;gt;2_name
ACGTTGCGGCATTCGATCGACGATCGATGCAAACGGTCACGGACTGACTGT
ACACACGTAGCAGCATCAGCATATTCGATGGCATCGATACCGGTTGGACGG
NNNNNNNNNNNNGGTGACACACGAGATATATFAGATCAACGTAAGGGATGA
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
AGTCGCTAGCATGCATGGCATATACGCGATCGATTCGATAGCTAGCGNNNN
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are two common formats for FASTA files:&lt;br /&gt;
- Single line FASTA&lt;br /&gt;
    Each record consists of two line: a name line (starts with &amp;ldquo;&amp;gt;&amp;rdquo;) and a sequence line.
- Multiline FASTA&lt;br /&gt;
    Each records consists of multiple lines, First line is a name line (starts with &amp;ldquo;&amp;gt;&amp;rdquo;), followed by multiple lines of sequences.&lt;/p&gt;

&lt;p&gt;Here I assume I&amp;rsquo;m dealing with multiline FASTA because if a script can work with multiline fasta, it&amp;rsquo;s generally easy to make it work with single line files.&lt;/p&gt;

&lt;p&gt;Here is how I approach it:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import sys

with open(&#39;test&#39;,&#39;r&#39;) as f:
    seq = []
    for line in f:
        if line.startswith(&amp;quot;&amp;gt;&amp;quot;):
            if seq: #seq not empty, process it
                trim = &#39;\n&#39;.join(&#39;&#39;.join(seq).replace(&amp;quot;N&amp;quot;,&amp;quot; &amp;quot;).split())
                print(trim)
                seq = []
            print(line.strip())
        else:
            #Read lines into a single seq
            seq.append(line.strip())
    if seq: #seq not empty, process it
                trim = &#39;\n&#39;.join(&#39;&#39;.join(seq).replace(&amp;quot;N&amp;quot;,&amp;quot; &amp;quot;).split())
                print(trim)
                seq = []
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;1_name
ACGTTGCGGCATTCGATCGACGATCGATGCAAACGGTCACGGACTGACTGTACACACGTAGCAGCATCAGCAT
GTTGGACGG
GGTGACACACGAGATATATFAGATCAACGTAAGGGATGA
AGTCGCTAGCATGCATGGCATATACGCGATCGATTCGATAGCTAGCG
&amp;gt;2_name
ACGTTGCGGCATTCGATCGACGATCGATGCAAACGGTCACGGACTGACTGTACACACGTAGCAGCATCAGCATATTCGATGGCATCGATACCGGTTGGACGG
GGTGACACACGAGATATATFAGATCAACGTAAGGGATGA
AGTCGCTAGCATGCATGGCATATACGCGATCGATTCGATAGCTAGCG
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Calculate row sums and col means with tidyR</title>
      <link>/post/calculate-row-sums-and-col-means-with-tidyr/</link>
      <pubDate>Mon, 11 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/calculate-row-sums-and-col-means-with-tidyr/</guid>
      <description>


&lt;p&gt;Recently Someone asked a question on reddit:
&lt;a href=&#34;https://www.reddit.com/r/Rlanguage/comments/azwcs5/adding_a_row_and_a_column_that_are_means_for_a/&#34;&gt;Adding a row and a column that are means for a set matrix&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This is a very simple problem that many of us learned how to do only a few hours in to basic R. But since I’ve been learning tidyverse package, I figured why not do it tidy-fashion?&lt;/p&gt;
&lt;p&gt;Let’s give it a try.&lt;/p&gt;
&lt;p&gt;Here is the question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I have the following sequence:&lt;br /&gt;
&lt;code&gt;S&amp;lt;-seq(1,90, by=3)&lt;/code&gt;&lt;br /&gt;
I make a matrix that is the following:&lt;br /&gt;
&lt;code&gt;matrix(S, nrow = 6, ncol = 5)&lt;/code&gt;&lt;br /&gt;
Now I am trying to do the following:&lt;br /&gt;
I want to calculate the means of the columns of the matrix and add them as a new row under the columns.&lt;br /&gt;
Next I want to calculate the sum of the rows of the matrix and add them as a new column on the right of the matrix.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Here is what their data looks like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;data_matrix = matrix(seq(1, 90, by = 3), nrow = 6, ncol = 5)
data_matrix&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3] [,4] [,5]
## [1,]    1   19   37   55   73
## [2,]    4   22   40   58   76
## [3,]    7   25   43   61   79
## [4,]   10   28   46   64   82
## [5,]   13   31   49   67   85
## [6,]   16   34   52   70   88&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;They want to calculate the mean of each column and sum of each row.&lt;br /&gt;
Now if you know some basic R this can very easily be achieved:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;data_df = data.frame(data_matrix)
data_df[,ncol(data_df)+1] = rowSums(data_df)
data_df[nrow(data_df)+1,] = colMeans(data_df)
head(data_df)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   X1 X2 X3 X4 X5  V6
## 1  1 19 37 55 73 185
## 2  4 22 40 58 76 200
## 3  7 25 43 61 79 215
## 4 10 28 46 64 82 230
## 5 13 31 49 67 85 245
## 6 16 34 52 70 88 260&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But how can we do this “tidy” way? Turns out this is more complicated than I originally thought.&lt;/p&gt;
&lt;p&gt;First let’s breath some context into our data so we don’t get too bored:&lt;br /&gt;
Let’s say we had an exam in a class of 50 students. The exam consists of 5 questions. TAs recorded the score of each question for each student on an excel sheet. The spreadsheet data has 5 columns, each for a question and 50 rows, each for a student. Now we want to calculate:&lt;br /&gt;
1. Total score for each student (row sums)&lt;br /&gt;
2. Class average for each question (col means)&lt;/p&gt;
&lt;p&gt;Let’s first creat this “spreadsheet”&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;scores_df = data.frame(matrix(sample(1:20,250, replace = TRUE), nrow = 50, ncol = 5))
head(scores_df)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   X1 X2 X3 X4 X5
## 1 19 13  7  9 16
## 2  5 11 12 14 19
## 3  5 11  6  8 20
## 4  8  9  8  9  6
## 5  3 14  4  7  6
## 6  8 12  6 15 15&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here we have a data frame with 5 colmuns (5 questions) and 50 rows (50 students).&lt;br /&gt;
Now the next step is to for tidy data: key-value pairs.&lt;br /&gt;
First we need to identify the keys: in our dataset, each student-question pair uniquely identifies a value (score). So we can gather our date like this:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidyverse)
scores_tibble = gather(rownames_to_column(scores_df, var = &amp;quot;student&amp;quot;), question, score, -student)
head(scores_tibble)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   student question score
## 1       1       X1    19
## 2       2       X1     5
## 3       3       X1     5
## 4       4       X1     8
## 5       5       X1     3
## 6       6       X1     8&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here I did not &lt;code&gt;unite()&lt;/code&gt; &lt;code&gt;student&lt;/code&gt; and &lt;code&gt;question&lt;/code&gt; into a single column so that later I can group by either student or question to calculate mean and sum.&lt;br /&gt;
Now to calculate question means:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summarise(group_by(scores_tibble, question), mean = mean(score))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 5 x 2
##   question  mean
##   &amp;lt;chr&amp;gt;    &amp;lt;dbl&amp;gt;
## 1 X1       11   
## 2 X2       11.1 
## 3 X3        9.7 
## 4 X4        9.78
## 5 X5       10.8&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Student sum scores:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summarise(group_by(scores_tibble, student), total = sum(score))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 50 x 2
##    student total
##    &amp;lt;chr&amp;gt;   &amp;lt;int&amp;gt;
##  1 1          64
##  2 10         46
##  3 11         78
##  4 12         63
##  5 13         50
##  6 14         56
##  7 15         44
##  8 16         40
##  9 17         64
## 10 18         43
## # … with 40 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s get a single table with all information&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;scores_complete = group_by(scores_tibble, question) %&amp;gt;%
  mutate(question_average = mean(score)) %&amp;gt;%
    group_by(student) %&amp;gt;%
      mutate(student_total = sum(score))
scores_complete&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 250 x 5
## # Groups:   student [50]
##    student question score question_average student_total
##    &amp;lt;chr&amp;gt;   &amp;lt;chr&amp;gt;    &amp;lt;int&amp;gt;            &amp;lt;dbl&amp;gt;         &amp;lt;int&amp;gt;
##  1 1       X1          19               11            64
##  2 2       X1           5               11            61
##  3 3       X1           5               11            50
##  4 4       X1           8               11            40
##  5 5       X1           3               11            34
##  6 6       X1           8               11            56
##  7 7       X1           2               11            53
##  8 8       X1           1               11            42
##  9 9       X1          17               11            63
## 10 10      X1           8               11            46
## # … with 240 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With a tidy table we can easily calculate stats we want and add them to the original data frame:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;scores_df_complete = spread(scores_tibble, question, score) %&amp;gt;%
  left_join(summarise(group_by(scores_tibble, student), student_total = sum(score)), by = &amp;quot;student&amp;quot;) %&amp;gt;%
    bind_rows(spread(summarise(group_by(scores_tibble, question), question_mean = mean(score)), question, question_mean))
head(scores_df_complete)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##   student X1 X2 X3 X4 X5 student_total
## 1       1 19 13  7  9 16            64
## 2      10  8 20  4  1 13            46
## 3      11 15 19 10 18 16            78
## 4      12  6 14 13 20 10            63
## 5      13  3  6 13 19  9            50
## 6      14 10 19 10 15  2            56&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;tail(scores_df_complete)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    student X1    X2   X3    X4    X5 student_total
## 46      50 12 20.00 17.0 19.00  1.00            69
## 47       6  8 12.00  6.0 15.00 15.00            56
## 48       7  2  9.00 18.0 15.00  9.00            53
## 49       8  1 16.00 11.0  3.00 11.00            42
## 50       9 17  8.00  9.0 11.00 18.00            63
## 51    &amp;lt;NA&amp;gt; 11 11.08  9.7  9.78 10.84            NA&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Example Page</title>
      <link>/tutorial/example/</link>
      <pubDate>Sun, 09 Sep 2018 00:00:00 -0700</pubDate>
      
      <guid>/tutorial/example/</guid>
      <description>

&lt;p&gt;In this tutorial, I&amp;rsquo;ll share my top 10 tips for getting started with Academic:&lt;/p&gt;

&lt;h2 id=&#34;tip-1&#34;&gt;Tip 1&lt;/h2&gt;

&lt;p&gt;&amp;hellip;&lt;/p&gt;

&lt;h2 id=&#34;tip-2&#34;&gt;Tip 2&lt;/h2&gt;

&lt;p&gt;&amp;hellip;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Privacy Policy</title>
      <link>/privacy/</link>
      <pubDate>Thu, 28 Jun 2018 00:00:00 -0700</pubDate>
      
      <guid>/privacy/</guid>
      <description>&lt;p&gt;&amp;hellip;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Example Talk</title>
      <link>/talk/example/</link>
      <pubDate>Sun, 01 Jan 2017 00:00:00 -0800</pubDate>
      
      <guid>/talk/example/</guid>
      <description>&lt;div class=&#34;alert alert-note&#34;&gt;
  &lt;div&gt;
    
Click on the **Slides** button above to view the built-in slides feature.

  &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Slides can be added in a few ways:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Create&lt;/strong&gt; slides using Academic&amp;rsquo;s &lt;em&gt;Slides&lt;/em&gt; feature and link using &lt;code&gt;url_slides&lt;/code&gt; parameter in the front matter of the talk file&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Upload&lt;/strong&gt; an existing slide deck to &lt;code&gt;static/&lt;/code&gt; and link using &lt;code&gt;url_slides&lt;/code&gt; parameter in the front matter of the talk file&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Embed&lt;/strong&gt; your slides (e.g. Google Slides) or presentation video on this page using &lt;a href=&#34;https://sourcethemes.com/academic/docs/writing-markdown-latex/&#34; target=&#34;_blank&#34;&gt;shortcodes&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Further talk details can easily be added to this page using &lt;em&gt;Markdown&lt;/em&gt; and $\rm \LaTeX$ math code.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Slides</title>
      <link>/slides/example-slides/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>/slides/example-slides/</guid>
      <description>

&lt;h1 id=&#34;welcome-to-slides&#34;&gt;Welcome to Slides&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://sourcethemes.com/academic/&#34; target=&#34;_blank&#34;&gt;Academic&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;features&#34;&gt;Features&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Efficiently write slides in Markdown&lt;/li&gt;
&lt;li&gt;3-in-1: Create, Present, and Publish your slides&lt;/li&gt;
&lt;li&gt;Supports speaker notes&lt;/li&gt;
&lt;li&gt;Mobile friendly slides&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;controls&#34;&gt;Controls&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Next: &lt;code&gt;Right Arrow&lt;/code&gt; or &lt;code&gt;Space&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Previous: &lt;code&gt;Left Arrow&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Start: &lt;code&gt;Home&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Finish: &lt;code&gt;End&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Overview: &lt;code&gt;Esc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Speaker notes: &lt;code&gt;S&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Fullscreen: &lt;code&gt;F&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Zoom: &lt;code&gt;Alt + Click&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hakimel/reveal.js#pdf-export&#34; target=&#34;_blank&#34;&gt;PDF Export&lt;/a&gt;: &lt;code&gt;E&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;code-highlighting&#34;&gt;Code Highlighting&lt;/h2&gt;

&lt;p&gt;Inline code: &lt;code&gt;variable&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Code block:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;porridge = &amp;quot;blueberry&amp;quot;
if porridge == &amp;quot;blueberry&amp;quot;:
    print(&amp;quot;Eating...&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;math&#34;&gt;Math&lt;/h2&gt;

&lt;p&gt;In-line math: $x + y = z$&lt;/p&gt;

&lt;p&gt;Block math:&lt;/p&gt;

&lt;p&gt;$$
f\left( x \right) = \;\frac{{2\left( {x + 4} \right)\left( {x - 4} \right)}}{{\left( {x + 4} \right)\left( {x + 1} \right)}}
$$&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;fragments&#34;&gt;Fragments&lt;/h2&gt;

&lt;p&gt;Make content appear incrementally&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{{% fragment %}} One {{% /fragment %}}
{{% fragment %}} **Two** {{% /fragment %}}
{{% fragment %}} Three {{% /fragment %}}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Press &lt;code&gt;Space&lt;/code&gt; to play!&lt;/p&gt;

&lt;p&gt;&lt;span class=&#34;fragment &#34; &gt;
   One
&lt;/span&gt;
&lt;span class=&#34;fragment &#34; &gt;
   &lt;strong&gt;Two&lt;/strong&gt;
&lt;/span&gt;
&lt;span class=&#34;fragment &#34; &gt;
   Three
&lt;/span&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;A fragment can accept two optional parameters:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;class&lt;/code&gt;: use a custom style (requires definition in custom CSS)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;weight&lt;/code&gt;: sets the order in which a fragment appears&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;speaker-notes&#34;&gt;Speaker Notes&lt;/h2&gt;

&lt;p&gt;Add speaker notes to your presentation&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-markdown&#34;&gt;{{% speaker_note %}}
- Only the speaker can read these notes
- Press `S` key to view
{{% /speaker_note %}}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Press the &lt;code&gt;S&lt;/code&gt; key to view the speaker notes!&lt;/p&gt;

&lt;aside class=&#34;notes&#34;&gt;
  &lt;ul&gt;
&lt;li&gt;Only the speaker can read these notes&lt;/li&gt;
&lt;li&gt;Press &lt;code&gt;S&lt;/code&gt; key to view&lt;/li&gt;
&lt;/ul&gt;
&lt;/aside&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;themes&#34;&gt;Themes&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;black: Black background, white text, blue links (default)&lt;/li&gt;
&lt;li&gt;white: White background, black text, blue links&lt;/li&gt;
&lt;li&gt;league: Gray background, white text, blue links&lt;/li&gt;
&lt;li&gt;beige: Beige background, dark text, brown links&lt;/li&gt;
&lt;li&gt;sky: Blue background, thin dark text, blue links&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;night: Black background, thick white text, orange links&lt;/li&gt;
&lt;li&gt;serif: Cappuccino background, gray text, brown links&lt;/li&gt;
&lt;li&gt;simple: White background, black text, blue links&lt;/li&gt;
&lt;li&gt;solarized: Cream-colored background, dark green text, blue links&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;


&lt;section data-noprocess data-shortcode-slide
  
      
      data-background-image=&#34;/img/boards.jpg&#34;
  &gt;


&lt;h2 id=&#34;custom-slide&#34;&gt;Custom Slide&lt;/h2&gt;

&lt;p&gt;Customize the slide style and background&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-markdown&#34;&gt;{{&amp;lt; slide background-image=&amp;quot;/img/boards.jpg&amp;quot; &amp;gt;}}
{{&amp;lt; slide background-color=&amp;quot;#0000FF&amp;quot; &amp;gt;}}
{{&amp;lt; slide class=&amp;quot;my-style&amp;quot; &amp;gt;}}
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;custom-css-example&#34;&gt;Custom CSS Example&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s make headers navy colored.&lt;/p&gt;

&lt;p&gt;Create &lt;code&gt;assets/css/reveal_custom.css&lt;/code&gt; with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-css&#34;&gt;.reveal section h1,
.reveal section h2,
.reveal section h3 {
  color: navy;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;h1 id=&#34;questions&#34;&gt;Questions?&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://discourse.gohugo.io&#34; target=&#34;_blank&#34;&gt;Ask&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://sourcethemes.com/academic/docs/&#34; target=&#34;_blank&#34;&gt;Documentation&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
